<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>UbixOS V2: src/sys/net/net/sys_arch.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_897b6a2d7bab147dd1db58381aad3984.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_832905b1f7f5feaf61a306b40c0ac817.html">sys</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_da977d215fccd664f66e7711fda26f76.html">net</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_b2e9f53f507f0bb44cd3f7446945d199.html">net</a></div>
<h1>sys_arch.c</h1><a href="sys__arch_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2001, Swedish Institute of Computer Science.</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved. </span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without </span>
<a name="l00006"></a>00006 <span class="comment"> * modification, are permitted provided that the following conditions </span>
<a name="l00007"></a>00007 <span class="comment"> * are met: </span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright </span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer. </span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright </span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the </span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution. </span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the Institute nor the names of its contributors </span>
<a name="l00014"></a>00014 <span class="comment"> *    may be used to endorse or promote products derived from this software </span>
<a name="l00015"></a>00015 <span class="comment"> *    without specific prior written permission. </span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND </span>
<a name="l00018"></a>00018 <span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="l00019"></a>00019 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
<a name="l00020"></a>00020 <span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE </span>
<a name="l00021"></a>00021 <span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL </span>
<a name="l00022"></a>00022 <span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS </span>
<a name="l00023"></a>00023 <span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) </span>
<a name="l00024"></a>00024 <span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT </span>
<a name="l00025"></a>00025 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY </span>
<a name="l00026"></a>00026 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF </span>
<a name="l00027"></a>00027 <span class="comment"> * SUCH DAMAGE. </span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * This file is part of the lwIP TCP/IP stack.</span>
<a name="l00030"></a>00030 <span class="comment"> * </span>
<a name="l00031"></a>00031 <span class="comment"> * Author:     Adam Dunkels      &lt;adam@sics.se&gt;</span>
<a name="l00032"></a>00032 <span class="comment"> * Sub Author: Christopher Olsen &lt;colsen@domaintlantic.com&gt;</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> * Notes:</span>
<a name="l00035"></a>00035 <span class="comment"> *  Modified to work with the ubix operating system</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * $Log: sys__arch_8c-source.html,v $
<a name="l00037"></a>00037 <span class="comment"> * Revision 1.5  2006/12/12 14:09:08  reddawg
<a name="l00037"></a>00037 <span class="comment"> * Changes
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> * Revision 1.1.1.1  2006/06/01 12:46:16  reddawg</span>
<a name="l00039"></a>00039 <span class="comment"> * ubix2</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> * Revision 1.2  2005/10/12 00:13:37  reddawg</span>
<a name="l00042"></a>00042 <span class="comment"> * Removed</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * Revision 1.1.1.1  2005/09/26 17:24:31  reddawg</span>
<a name="l00045"></a>00045 <span class="comment"> * no message</span>
<a name="l00046"></a>00046 <span class="comment"> *</span>
<a name="l00047"></a>00047 <span class="comment"> * Revision 1.6  2004/09/11 21:30:37  apwillia</span>
<a name="l00048"></a>00048 <span class="comment"> * Fix race conditions in net thread and scheduler</span>
<a name="l00049"></a>00049 <span class="comment"> *</span>
<a name="l00050"></a>00050 <span class="comment"> * Revision 1.5  2004/09/07 20:58:35  reddawg</span>
<a name="l00051"></a>00051 <span class="comment"> * time to roll back i can't think straight by friday</span>
<a name="l00052"></a>00052 <span class="comment"> *</span>
<a name="l00053"></a>00053 <span class="comment"> * Revision 1.4  2004/05/25 22:49:29  reddawg</span>
<a name="l00054"></a>00054 <span class="comment"> * Stupid Old CODE!!!</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> * Revision 1.3  2004/05/19 04:07:43  reddawg</span>
<a name="l00057"></a>00057 <span class="comment"> * kmalloc(size,pid) no more it is no kmalloc(size); the way it should of been</span>
<a name="l00058"></a>00058 <span class="comment"> *</span>
<a name="l00059"></a>00059 <span class="comment"> * Revision 1.2  2004/05/19 03:35:02  reddawg</span>
<a name="l00060"></a>00060 <span class="comment"> * Fixed A Few Ordering Issues In The Service Startup Routine</span>
<a name="l00061"></a>00061 <span class="comment"> *</span>
<a name="l00062"></a>00062 <span class="comment"> * Revision 1.1.1.1  2004/04/15 12:07:14  reddawg</span>
<a name="l00063"></a>00063 <span class="comment"> * UbixOS v1.0</span>
<a name="l00064"></a>00064 <span class="comment"> *</span>
<a name="l00065"></a>00065 <span class="comment"> * Revision 1.13  2004/04/13 21:29:53  reddawg</span>
<a name="l00066"></a>00066 <span class="comment"> * We now have sockets working. Lots of functionality to be added to continually</span>
<a name="l00067"></a>00067 <span class="comment"> * improve on the existing layers now its clean up time to get things in a better</span>
<a name="l00068"></a>00068 <span class="comment"> * working order.</span>
<a name="l00069"></a>00069 <span class="comment"> *</span>
<a name="l00070"></a>00070 <span class="comment"> * Revision 1.12  2004/04/13 16:08:07  reddawg</span>
<a name="l00071"></a>00071 <span class="comment"> * Removed all of the old debug code the problem seems to be in ubthreads with</span>
<a name="l00072"></a>00072 <span class="comment"> * ubthread_mutex_init</span>
<a name="l00073"></a>00073 <span class="comment"> *</span>
<a name="l00074"></a>00074 <span class="comment"> * Revision 1.11  2004/04/13 16:05:40  reddawg</span>
<a name="l00075"></a>00075 <span class="comment"> * Function Renaming</span>
<a name="l00076"></a>00076 <span class="comment"> *</span>
<a name="l00077"></a>00077 <span class="comment"> *</span>
<a name="l00078"></a>00078 <span class="comment"> *</span>
<a name="l00079"></a>00079 <span class="comment"> * $Id: sys__arch_8c-source.html 88 2016-01-12 00:11:29Z reddawg $</span>
<a name="l00080"></a>00080 <span class="comment"> */</span>
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html">ubixos/types.h</a>&gt;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &lt;<a class="code" href="sched_8h.html">ubixos/sched.h</a>&gt;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &lt;<a class="code" href="ubthread_8h.html">ubixos/ubthread.h</a>&gt;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &lt;<a class="code" href="kpanic_8h.html">ubixos/kpanic.h</a>&gt;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &lt;<a class="code" href="kprintf_8h.html">lib/kprintf.h</a>&gt;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &lt;<a class="code" href="kmalloc_8h.html">lib/kmalloc.h</a>&gt;</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">net/debug.h</a>"</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include "<a class="code" href="sys_8h.html">net/sys.h</a>"</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include "<a class="code" href="opt_8h.html">net/opt.h</a>"</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include "<a class="code" href="stats_8h.html">net/stats.h</a>"</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="preprocessor">#include &lt;<a class="code" href="spinlock_8h.html">ubixos/spinlock.h</a>&gt;</span>
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="sys__arch_8c.html#55b0bf94baa06c302a48157cd42cd676">00096</a> <span class="preprocessor">#define UMAX(a, b)      ((a) &gt; (b) ? (a) : (b))</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="sys__arch_8c.html#15905349139e42ffd3f853e8daae250f">00098</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> *<a class="code" href="sys__arch_8c.html#15905349139e42ffd3f853e8daae250f">threads</a> = 0x0;
<a name="l00099"></a><a class="code" href="sys__arch_8c.html#ca0303cc326b3efc7d32b4a794ddeb61">00099</a> <span class="keyword">static</span> <a class="code" href="spinlock_8h.html#a240e9404b4ede1e0d714610080d1176">spinLock_t</a> <a class="code" href="sys__arch_8c.html#ca0303cc326b3efc7d32b4a794ddeb61">netThreadSpinlock</a> = <a class="code" href="spinlock_8h.html#0fe85a4f3642683148b25916d6c5eafd">SPIN_LOCK_INITIALIZER</a>;
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="structsys__mbox__msg.html">00101</a> <span class="keyword">struct </span><a class="code" href="structsys__mbox__msg.html">sys_mbox_msg</a> {
<a name="l00102"></a><a class="code" href="structsys__mbox__msg.html#aee9d483ae1aedfb4c5ebea30cd2f84b">00102</a>   <span class="keyword">struct </span><a class="code" href="structsys__mbox__msg.html">sys_mbox_msg</a> *<a class="code" href="structsys__mbox__msg.html#aee9d483ae1aedfb4c5ebea30cd2f84b">next</a>;
<a name="l00103"></a><a class="code" href="structsys__mbox__msg.html#5902d8670558a8892e739c37804e20e5">00103</a>   <span class="keywordtype">void</span> *<a class="code" href="structsys__mbox__msg.html#5902d8670558a8892e739c37804e20e5">msg</a>;
<a name="l00104"></a>00104 };
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="sys__arch_8c.html#b6084e542da137ecb93bb42ce1087518">00106</a> <span class="preprocessor">#define SYS_MBOX_SIZE 100</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>
<a name="l00108"></a><a class="code" href="structsys__mbox.html">00108</a> <span class="keyword">struct </span><a class="code" href="structsys__mbox.html">sys_mbox</a> {
<a name="l00109"></a><a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">00109</a>   <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> <a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a>, <a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a>;
<a name="l00110"></a><a class="code" href="structsys__mbox.html#dc8ebbfd1d184d1edbd541903597cc5a">00110</a>   <span class="keywordtype">void</span> *<a class="code" href="structsys__mbox.html#dc8ebbfd1d184d1edbd541903597cc5a">msgs</a>[<a class="code" href="sys__arch_8c.html#b6084e542da137ecb93bb42ce1087518">SYS_MBOX_SIZE</a>];
<a name="l00111"></a><a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">00111</a>   <span class="keyword">struct </span><a class="code" href="structsys__sem.html">sys_sem</a> *<a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">mail</a>;
<a name="l00112"></a><a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">00112</a>   <span class="keyword">struct </span><a class="code" href="structsys__sem.html">sys_sem</a> *<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>;
<a name="l00113"></a>00113 };
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="structsys__sem.html">00115</a> <span class="keyword">struct </span><a class="code" href="structsys__sem.html">sys_sem</a> {
<a name="l00116"></a><a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">00116</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">c</a>;
<a name="l00117"></a><a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">00117</a>   <a class="code" href="structubthread__cond.html">ubthread_cond_t</a> <a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>;
<a name="l00118"></a><a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">00118</a>   <a class="code" href="structubthread__mutex.html">ubthread_mutex_t</a> <a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>;
<a name="l00119"></a>00119 };
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="structsys__thread.html">00121</a> <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> {
<a name="l00122"></a><a class="code" href="structsys__thread.html#30bbf3f21718b4c9579777d2ba4d6528">00122</a>   <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> *<a class="code" href="structsys__thread.html#30bbf3f21718b4c9579777d2ba4d6528">next</a>;
<a name="l00123"></a><a class="code" href="structsys__thread.html#bf0a0f75b1958421416c879d8011413b">00123</a>   <span class="keyword">struct </span><a class="code" href="structsys__timeouts.html">sys_timeouts</a> <a class="code" href="structsys__thread.html#bf0a0f75b1958421416c879d8011413b">timeouts</a>;
<a name="l00124"></a><a class="code" href="structsys__thread.html#109a6dc4db2e0d62aa546ce36f3fbc1b">00124</a>   <a class="code" href="structtaskStruct.html">kTask_t</a> *<a class="code" href="structubthread.html">ubthread</a>;
<a name="l00125"></a>00125 };
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 
<a name="l00128"></a><a class="code" href="sys__arch_8c.html#726d4f4e11d7b38233574938939e0db9">00128</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structtimeval.html">timeval</a> <a class="code" href="sys__arch_8c.html#726d4f4e11d7b38233574938939e0db9">starttime</a>;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsys__sem.html">sys_sem</a> *<a class="code" href="sys__arch_8c.html#7e7a76cc67fb974dbc234d15f9b885fe">sys_sem_new_</a>(<a class="code" href="types_8h.html#a4e0f27a9aca905e340c06d2dcae843c">uInt8</a> count);
<a name="l00131"></a>00131 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="sys__arch_8c.html#2c773782116a4e712bd8d4c591ab50d4">sys_sem_free_</a>(<span class="keyword">struct</span> <a class="code" href="structsys__sem.html">sys_sem</a> *sem);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="keyword">static</span> <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> <a class="code" href="sys__arch_8c.html#acaa002113dc0d59d767efbb1382e1ca">cond_wait</a>(<a class="code" href="structubthread__cond.html">ubthread_cond_t</a> *<a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>, <a class="code" href="structubthread__mutex.html">ubthread_mutex_t</a> *<a class="code" href="ubthread_8c.html#18b6be9ca0cec4b0643171232d6f10de">mutex</a>, <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> timeout);
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="sys__arch_8c.html#c216bafdd6453f68ef27dc764b134e94">00135</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> *<a class="code" href="sys__arch_8c.html#c216bafdd6453f68ef27dc764b134e94">current_thread</a>(<span class="keywordtype">void</span>) {
<a name="l00136"></a>00136   <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> *st;
<a name="l00137"></a>00137   <a class="code" href="structtaskStruct.html">kTask_t</a> *pt;
<a name="l00138"></a>00138   pt = <a class="code" href="ubthread_8h.html#72a362bc8127b8d63e1107062638664d">ubthread_self</a>();
<a name="l00139"></a>00139   <a class="code" href="spinlock_8h.html#2cd9a4502680fb8e7f0fe6b029e558b1">spinLock</a>(&amp;<a class="code" href="sys__arch_8c.html#ca0303cc326b3efc7d32b4a794ddeb61">netThreadSpinlock</a>);
<a name="l00140"></a>00140   <span class="keywordflow">for</span>(st = <a class="code" href="sys__arch_8c.html#15905349139e42ffd3f853e8daae250f">threads</a>; st != <a class="code" href="def_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; st = st-&gt;<a class="code" href="structsys__thread.html#30bbf3f21718b4c9579777d2ba4d6528">next</a>) {
<a name="l00141"></a>00141     <span class="keywordflow">if</span>(st-&gt;<a class="code" href="structsys__thread.html#109a6dc4db2e0d62aa546ce36f3fbc1b">ubthread</a> == pt) {
<a name="l00142"></a>00142       <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="sys__arch_8c.html#ca0303cc326b3efc7d32b4a794ddeb61">netThreadSpinlock</a>);
<a name="l00143"></a>00143       <span class="keywordflow">return</span> st;
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145   }
<a name="l00146"></a>00146   <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="sys__arch_8c.html#ca0303cc326b3efc7d32b4a794ddeb61">netThreadSpinlock</a>);
<a name="l00147"></a>00147   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"sys: current_thread: could not find current thread!\n"</span>);
<a name="l00148"></a>00148   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"This is due to a race condition in the LinuxThreads\n"</span>);
<a name="l00149"></a>00149   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"ubthreads implementation. Start the program again.\n"</span>);
<a name="l00150"></a>00150   
<a name="l00151"></a>00151   <a class="code" href="kpanic_8h.html#db9a182aa071791a306163d50d653deb">kpanic</a>(<span class="stringliteral">"ABORT"</span>);
<a name="l00152"></a>00152   <span class="keywordflow">return</span>(0x0);
<a name="l00153"></a>00153   }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="structthread__start__param.html">00156</a> <span class="keyword">struct </span><a class="code" href="structthread__start__param.html">thread_start_param</a> {
<a name="l00157"></a><a class="code" href="structthread__start__param.html#6cf526706b3be43bb00e750118687148">00157</a>   <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> *<a class="code" href="structthread.html">thread</a>;
<a name="l00158"></a>00158   void (* <a class="code" href="structthread__start__param.html#7773a5446ce0e9e9badc6489d9f097ff">function</a>)(<span class="keywordtype">void</span> *);
<a name="l00159"></a><a class="code" href="structthread__start__param.html#371e37a29e019c871fda24c2118c2896">00159</a>   <span class="keywordtype">void</span> *<a class="code" href="structthread__start__param.html#371e37a29e019c871fda24c2118c2896">arg</a>;
<a name="l00160"></a>00160   };
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="comment">/*</span>
<a name="l00163"></a>00163 <span class="comment">static void *thread_start(void *arg) {</span>
<a name="l00164"></a>00164 <span class="comment">  struct thread_start_param *tp = arg;</span>
<a name="l00165"></a>00165 <span class="comment">  tp-&gt;thread-&gt;ubthread = ubthread_self();</span>
<a name="l00166"></a>00166 <span class="comment">  tp-&gt;function(tp-&gt;arg);</span>
<a name="l00167"></a>00167 <span class="comment">  kfree(tp);</span>
<a name="l00168"></a>00168 <span class="comment">  return(NULL);</span>
<a name="l00169"></a>00169 <span class="comment">  }</span>
<a name="l00170"></a>00170 <span class="comment">*/</span>
<a name="l00171"></a>00171 
<a name="l00172"></a><a class="code" href="sys__arch_8c.html#eb9b7d7cea295be85b0b0ddb7c9fe566">00172</a> <span class="keywordtype">void</span> <a class="code" href="sys_8h.html#eb9b7d7cea295be85b0b0ddb7c9fe566">sys_thread_new</a>(<span class="keywordtype">void</span> (* function)(<span class="keywordtype">void</span>), <span class="keywordtype">void</span> *arg) {
<a name="l00173"></a>00173   <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> *<a class="code" href="structthread.html">thread</a> = 0x0;
<a name="l00174"></a>00174   <span class="comment">//struct thread_start_param *thread_param;</span>
<a name="l00175"></a>00175   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"sys_thread: [0x%X]\n"</span>,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsys__thread.html">sys_thread</a>));
<a name="l00176"></a>00176   
<a name="l00177"></a>00177   thread = <a class="code" href="kmalloc_8h.html#150eab2ac4ce4553e21ca10e7f441762">kmalloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sys_thread));
<a name="l00178"></a>00178   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"THREAD: [0x%X]\n"</span>,thread);
<a name="l00179"></a>00179   <a class="code" href="spinlock_8h.html#2cd9a4502680fb8e7f0fe6b029e558b1">spinLock</a>(&amp;<a class="code" href="sys__arch_8c.html#ca0303cc326b3efc7d32b4a794ddeb61">netThreadSpinlock</a>);
<a name="l00180"></a>00180   thread-&gt;<a class="code" href="structsys__thread.html#30bbf3f21718b4c9579777d2ba4d6528">next</a> = <a class="code" href="sys__arch_8c.html#15905349139e42ffd3f853e8daae250f">threads</a>;
<a name="l00181"></a>00181   thread-&gt;<a class="code" href="structsys__thread.html#bf0a0f75b1958421416c879d8011413b">timeouts</a>.<a class="code" href="structsys__timeouts.html#80922134cf5f7db06829b6ee49b4954c">next</a> = <a class="code" href="def_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00182"></a>00182   thread-&gt;<a class="code" href="structsys__thread.html#109a6dc4db2e0d62aa546ce36f3fbc1b">ubthread</a> = 0x0;
<a name="l00183"></a>00183   <a class="code" href="sys__arch_8c.html#15905349139e42ffd3f853e8daae250f">threads</a> = thread;
<a name="l00184"></a>00184   <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="sys__arch_8c.html#ca0303cc326b3efc7d32b4a794ddeb61">netThreadSpinlock</a>);
<a name="l00185"></a>00185   
<a name="l00186"></a>00186 
<a name="l00187"></a>00187   <span class="comment">/*</span>
<a name="l00188"></a>00188 <span class="comment">  thread_param = kmalloc(sizeof(struct thread_start_param));</span>
<a name="l00189"></a>00189 <span class="comment">  </span>
<a name="l00190"></a>00190 <span class="comment">  thread_param-&gt;function = function;</span>
<a name="l00191"></a>00191 <span class="comment">  thread_param-&gt;arg = arg;</span>
<a name="l00192"></a>00192 <span class="comment">  thread_param-&gt;thread = thread;</span>
<a name="l00193"></a>00193 <span class="comment">  */</span>
<a name="l00194"></a>00194   <span class="comment">//execThread((void *)function,0x0,0x0);</span>
<a name="l00195"></a>00195  
<a name="l00196"></a>00196   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"thread-&gt;ubthread: [0x%X]\n"</span>,thread-&gt;<a class="code" href="structsys__thread.html#109a6dc4db2e0d62aa546ce36f3fbc1b">ubthread</a>);
<a name="l00197"></a>00197   <span class="keywordflow">if</span>(<a class="code" href="ubthread_8h.html#a0af177ef44888f3c93883294207328e">ubthread_create</a>(&amp;thread-&gt;<a class="code" href="structsys__thread.html#109a6dc4db2e0d62aa546ce36f3fbc1b">ubthread</a>, 0x0,(<span class="keywordtype">void</span> *)(function), arg) != 0x0) {
<a name="l00198"></a>00198     <a class="code" href="kpanic_8h.html#db9a182aa071791a306163d50d653deb">kpanic</a>(<span class="stringliteral">"sys_thread_new: ubthread_create"</span>);
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"thread-&gt;ubthread: [0x%X]\n"</span>,thread-&gt;<a class="code" href="structsys__thread.html#109a6dc4db2e0d62aa546ce36f3fbc1b">ubthread</a>); 
<a name="l00201"></a>00201   
<a name="l00202"></a>00202   }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="sys__arch_8c.html#fd77d183bb0693a21119223e72af96c2">00204</a> <span class="keyword">struct </span><a class="code" href="structsys__mbox.html">sys_mbox</a> *<a class="code" href="sys_8h.html#3b766e6df37d63d5f1144c5089c2af94">sys_mbox_new</a>() {
<a name="l00205"></a>00205   <span class="keyword">struct </span><a class="code" href="structsys__mbox.html">sys_mbox</a> *<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a> = <a class="code" href="kmalloc_8h.html#150eab2ac4ce4553e21ca10e7f441762">kmalloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsys__mbox.html">sys_mbox</a>));
<a name="l00208"></a>00208   <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a> = <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a> = 0;
<a name="l00209"></a>00209   <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">mail</a> = <a class="code" href="sys__arch_8c.html#7e7a76cc67fb974dbc234d15f9b885fe">sys_sem_new_</a>(0);
<a name="l00210"></a>00210   <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a> = <a class="code" href="sys__arch_8c.html#7e7a76cc67fb974dbc234d15f9b885fe">sys_sem_new_</a>(1);
<a name="l00211"></a>00211   
<a name="l00212"></a>00212   <span class="keywordflow">return</span>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>);
<a name="l00213"></a>00213   }
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="sys__arch_8c.html#5f93e13777922e6745f5aeb6bb27ee0b">00215</a> <span class="keywordtype">void</span> <a class="code" href="sys_8h.html#66160e039d0222f4dd8534cd3ab84699">sys_mbox_free</a>(<span class="keyword">struct</span> <a class="code" href="structsys__mbox.html">sys_mbox</a> *<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>) {
<a name="l00216"></a>00216   <span class="keywordflow">if</span> (<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a> != <a class="code" href="sys__arch_8h.html#151f190d8a41cf6e2a02e0eec2b75355">SYS_MBOX_NULL</a>) {
<a name="l00217"></a>00217     <a class="code" href="sys_8h.html#6c4530613bd616e719a295779b87ae5c">sys_sem_wait</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>);
<a name="l00218"></a>00218     
<a name="l00219"></a>00219     <a class="code" href="sys__arch_8c.html#2c773782116a4e712bd8d4c591ab50d4">sys_sem_free_</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">mail</a>);
<a name="l00220"></a>00220     <a class="code" href="sys__arch_8c.html#2c773782116a4e712bd8d4c591ab50d4">sys_sem_free_</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>);
<a name="l00221"></a>00221     <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">mail</a> = <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a> = <a class="code" href="def_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00222"></a>00222     <span class="comment">//kprintf("sys_mbox_free: mbox 0x%lx\n", mbox);</span>
<a name="l00223"></a>00223     <a class="code" href="kmalloc_8h.html#aa9ed6886459604cf73ccdbf6410e487">kfree</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>);
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225   }
<a name="l00226"></a>00226 
<a name="l00227"></a><a class="code" href="sys__arch_8c.html#1e7a0edf077b67162d80fefffc8805fb">00227</a> <span class="keywordtype">void</span> <a class="code" href="sys_8h.html#217a9af37c5dd7c3fc16daddaacb976f">sys_mbox_post</a>(<span class="keyword">struct</span> <a class="code" href="structsys__mbox.html">sys_mbox</a> *<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>, <span class="keywordtype">void</span> *msg) {
<a name="l00228"></a>00228   <a class="code" href="types_8h.html#a4e0f27a9aca905e340c06d2dcae843c">uInt8</a> <a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a>;
<a name="l00229"></a>00229   
<a name="l00230"></a>00230   <a class="code" href="sys_8h.html#6c4530613bd616e719a295779b87ae5c">sys_sem_wait</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>);
<a name="l00231"></a>00231   
<a name="l00232"></a>00232   <span class="comment">//kprintf("sys_mbox_post: mbox %p msg %p\n", mbox, msg);</span>
<a name="l00233"></a>00233 
<a name="l00234"></a>00234   <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#dc8ebbfd1d184d1edbd541903597cc5a">msgs</a>[<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a>] = msg;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <span class="keywordflow">if</span> (<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a> == <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a>) {
<a name="l00237"></a>00237     first = 1;
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239   <span class="keywordflow">else</span> {
<a name="l00240"></a>00240     first = 0;
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242   
<a name="l00243"></a>00243   <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a>++;
<a name="l00244"></a>00244   <span class="keywordflow">if</span>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a> == <a class="code" href="sys__arch_8c.html#b6084e542da137ecb93bb42ce1087518">SYS_MBOX_SIZE</a>) {
<a name="l00245"></a>00245     <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a> = 0;
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   <span class="keywordflow">if</span>(first) {
<a name="l00249"></a>00249     <a class="code" href="sys_8h.html#dcdd78b22487e983e7636c636292fbfa">sys_sem_signal</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">mail</a>);
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251   <a class="code" href="sys_8h.html#dcdd78b22487e983e7636c636292fbfa">sys_sem_signal</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>);
<a name="l00252"></a>00252   }
<a name="l00253"></a>00253 
<a name="l00254"></a><a class="code" href="sys__arch_8c.html#d3bc5455ca12b164bfc78974ff0c1e3c">00254</a> <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> <a class="code" href="sys_8h.html#94ffa3f15cc0eda6dae85c6ccb88da6e">sys_arch_mbox_fetch</a>(<span class="keyword">struct</span> <a class="code" href="structsys__mbox.html">sys_mbox</a> *<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>, <span class="keywordtype">void</span> **msg, <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> timeout) {
<a name="l00255"></a>00255   <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> time = 1;
<a name="l00256"></a>00256   
<a name="l00257"></a>00257   <span class="comment">/* The mutex lock is quick so we don't bother with the timeout</span>
<a name="l00258"></a>00258 <span class="comment">     stuff here. */</span>
<a name="l00259"></a>00259   <a class="code" href="sys_8h.html#bf9681f6dcec783b38693e9d0b7af937">sys_arch_sem_wait</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>, 0);
<a name="l00260"></a>00260   
<a name="l00261"></a>00261   <span class="keywordflow">while</span>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a> == <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#e88d235ceab3354ef612e0be18456a01">last</a>) {
<a name="l00262"></a>00262     <a class="code" href="sys_8h.html#dcdd78b22487e983e7636c636292fbfa">sys_sem_signal</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>);
<a name="l00263"></a>00263     
<a name="l00264"></a>00264     <span class="comment">/* We block while waiting for a mail to arrive in the mailbox. We</span>
<a name="l00265"></a>00265 <span class="comment">       must be prepared to timeout. */</span>
<a name="l00266"></a>00266     <span class="keywordflow">if</span>(timeout != 0) {
<a name="l00267"></a>00267       time = <a class="code" href="sys_8h.html#bf9681f6dcec783b38693e9d0b7af937">sys_arch_sem_wait</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">mail</a>, timeout);
<a name="l00268"></a>00268       
<a name="l00269"></a>00269       <span class="comment">/* If time == 0, the sem_wait timed out, and we return 0. */</span>
<a name="l00270"></a>00270       <span class="keywordflow">if</span>(time == 0) {
<a name="l00271"></a>00271         <span class="keywordflow">return</span> 0;
<a name="l00272"></a>00272       }
<a name="l00273"></a>00273     } <span class="keywordflow">else</span> {
<a name="l00274"></a>00274       <a class="code" href="sys_8h.html#bf9681f6dcec783b38693e9d0b7af937">sys_arch_sem_wait</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#55a1a2b60ec2ffc998debbcdb68cb6fd">mail</a>, 0);
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276     
<a name="l00277"></a>00277     <a class="code" href="sys_8h.html#bf9681f6dcec783b38693e9d0b7af937">sys_arch_sem_wait</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>, 0);
<a name="l00278"></a>00278   }
<a name="l00279"></a>00279   
<a name="l00280"></a>00280   <span class="keywordflow">if</span>(msg != <a class="code" href="def_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00281"></a>00281     <span class="comment">//kprintf("sys_mbox_fetch: mbox %p msg %p\n", mbox, *msg);</span>
<a name="l00282"></a>00282     *msg = <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#dc8ebbfd1d184d1edbd541903597cc5a">msgs</a>[<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a>];
<a name="l00283"></a>00283   }
<a name="l00284"></a>00284   
<a name="l00285"></a>00285   <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a>++;
<a name="l00286"></a>00286   <span class="keywordflow">if</span>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a> == <a class="code" href="sys__arch_8c.html#b6084e542da137ecb93bb42ce1087518">SYS_MBOX_SIZE</a>) {
<a name="l00287"></a>00287     <a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#8db17d5a2fed5c240e46f2644f64fe6b">first</a> = 0;
<a name="l00288"></a>00288   }    
<a name="l00289"></a>00289   
<a name="l00290"></a>00290   <a class="code" href="sys_8h.html#dcdd78b22487e983e7636c636292fbfa">sys_sem_signal</a>(<a class="code" href="tcpip_8c.html#189da3fa172ad9c1b0491dcb4857fee6">mbox</a>-&gt;<a class="code" href="structsys__mbox.html#4c3d45a63605eee5abf52b98914ad5c7">mutex</a>);
<a name="l00291"></a>00291   
<a name="l00292"></a>00292   <span class="keywordflow">return</span>(time);
<a name="l00293"></a>00293   }
<a name="l00294"></a>00294 
<a name="l00295"></a><a class="code" href="sys__arch_8c.html#cf9c4261c404aabc9b7a836f54207a57">00295</a> <span class="keyword">struct </span><a class="code" href="structsys__sem.html">sys_sem</a> *<a class="code" href="sys_8h.html#adf2563f342b33ff6033eaa12f642e9d">sys_sem_new</a>(<a class="code" href="types_8h.html#a4e0f27a9aca905e340c06d2dcae843c">uInt8</a> count) {
<a name="l00296"></a>00296   <span class="keywordflow">return</span> <a class="code" href="sys__arch_8c.html#7e7a76cc67fb974dbc234d15f9b885fe">sys_sem_new_</a>(count);
<a name="l00297"></a>00297   }
<a name="l00298"></a>00298 
<a name="l00299"></a><a class="code" href="sys__arch_8c.html#7e7a76cc67fb974dbc234d15f9b885fe">00299</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsys__sem.html">sys_sem</a> *<a class="code" href="sys__arch_8c.html#7e7a76cc67fb974dbc234d15f9b885fe">sys_sem_new_</a>(<a class="code" href="types_8h.html#a4e0f27a9aca905e340c06d2dcae843c">uInt8</a> count) {
<a name="l00300"></a>00300   <span class="keyword">struct </span><a class="code" href="structsys__sem.html">sys_sem</a> *sem;
<a name="l00301"></a>00301   
<a name="l00302"></a>00302   sem = <a class="code" href="kmalloc_8h.html#150eab2ac4ce4553e21ca10e7f441762">kmalloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structsys__sem.html">sys_sem</a>));
<a name="l00303"></a>00303   sem-&gt;<a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">c</a> = count;
<a name="l00304"></a>00304   
<a name="l00305"></a>00305   <a class="code" href="ubthread_8h.html#cbb7170a68758468ab5b02512a320112">ubthread_cond_init</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>), <a class="code" href="def_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00306"></a>00306   <a class="code" href="ubthread_8h.html#b6bfc2169b55532821582f24b68dc855">ubthread_mutex_init</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>), <a class="code" href="def_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00307"></a>00307   
<a name="l00308"></a>00308   <span class="keywordflow">return</span> sem;
<a name="l00309"></a>00309   }
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="sys__arch_8c.html#acaa002113dc0d59d767efbb1382e1ca">00311</a> <span class="keyword">static</span> <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> <a class="code" href="sys__arch_8c.html#acaa002113dc0d59d767efbb1382e1ca">cond_wait</a>(<a class="code" href="structubthread__cond.html">ubthread_cond_t</a> *<a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>, <a class="code" href="structubthread__mutex.html">ubthread_mutex_t</a> *<a class="code" href="ubthread_8c.html#18b6be9ca0cec4b0643171232d6f10de">mutex</a>, <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> timeout) {
<a name="l00312"></a>00312   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tdiff;
<a name="l00313"></a>00313   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sec, usec;
<a name="l00314"></a>00314   <span class="keyword">struct </span><a class="code" href="structtimeval.html">timeval</a> rtime1, rtime2;
<a name="l00315"></a>00315   <span class="keyword">struct </span><a class="code" href="structtimespec.html">timespec</a> ts;
<a name="l00316"></a>00316   <span class="keyword">struct </span><a class="code" href="structtimezone.html">timezone</a> tz;
<a name="l00317"></a>00317   <span class="keywordtype">int</span> retval;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="keywordflow">if</span> (timeout &gt; 0) {
<a name="l00320"></a>00320     <span class="comment">/* Get a timestamp and add the timeout value. */</span>
<a name="l00321"></a>00321     <a class="code" href="time_8h.html#df30830f5265e55035171c301eb9c3fb">gettimeofday</a>(&amp;rtime1, &amp;tz);
<a name="l00322"></a>00322     sec = rtime1.<a class="code" href="structtimeval.html#3599199839a89e99a2ce29d45312b5cf">tv_sec</a>;
<a name="l00323"></a>00323     usec = rtime1.<a class="code" href="structtimeval.html#810bf8fcd58e255a5c1896d19538b86a">tv_usec</a>;
<a name="l00324"></a>00324     usec += timeout % 1000 * 1000;  
<a name="l00325"></a>00325     sec += (int)(timeout / 1000) + (int)(usec / 1000000);
<a name="l00326"></a>00326     usec = usec % 1000000;
<a name="l00327"></a>00327     ts.<a class="code" href="structtimespec.html#e3c7510dafa8cbcaede866ed13c99683">tv_nsec</a> = usec * 1000;
<a name="l00328"></a>00328     ts.<a class="code" href="structtimespec.html#fc3302668d7cb5952f590da69fdd4955">tv_sec</a> = sec;
<a name="l00329"></a>00329     
<a name="l00330"></a>00330     retval = <a class="code" href="ubthread_8h.html#996be9a927447a62f7168a082a046c54">ubthread_cond_timedwait</a>(cond, <a class="code" href="ubthread_8c.html#18b6be9ca0cec4b0643171232d6f10de">mutex</a>, &amp;ts);
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (retval == <a class="code" href="ubthread_8h.html#597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>) {
<a name="l00332"></a>00332       <span class="keywordflow">return</span> 0;
<a name="l00333"></a>00333       }
<a name="l00334"></a>00334     <span class="keywordflow">else</span> {
<a name="l00335"></a>00335       <span class="comment">/* Calculate for how long we waited for the cond. */</span>
<a name="l00336"></a>00336       <a class="code" href="time_8h.html#df30830f5265e55035171c301eb9c3fb">gettimeofday</a>(&amp;rtime2, &amp;tz);
<a name="l00337"></a>00337       tdiff = (rtime2.<a class="code" href="structtimeval.html#3599199839a89e99a2ce29d45312b5cf">tv_sec</a> - rtime1.<a class="code" href="structtimeval.html#3599199839a89e99a2ce29d45312b5cf">tv_sec</a>) * 1000 +  
<a name="l00338"></a>00338         (rtime2.<a class="code" href="structtimeval.html#810bf8fcd58e255a5c1896d19538b86a">tv_usec</a> - rtime1.<a class="code" href="structtimeval.html#810bf8fcd58e255a5c1896d19538b86a">tv_usec</a>) / 1000;
<a name="l00339"></a>00339       <span class="keywordflow">if</span> (tdiff == 0) {
<a name="l00340"></a>00340         <span class="keywordflow">return</span> 1;
<a name="l00341"></a>00341         }
<a name="l00342"></a>00342       <span class="keywordflow">return</span> tdiff;
<a name="l00343"></a>00343       }
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345   <span class="keywordflow">else</span> {
<a name="l00346"></a>00346     <a class="code" href="ubthread_8h.html#30eb7c156c2422801ddb86326dbc3d81">ubthread_cond_wait</a>(cond, <a class="code" href="ubthread_8c.html#18b6be9ca0cec4b0643171232d6f10de">mutex</a>);
<a name="l00347"></a>00347     <span class="keywordflow">return</span> 0;
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349   }
<a name="l00350"></a>00350 
<a name="l00351"></a><a class="code" href="sys__arch_8c.html#af7b79a80d625789c95cb20b565424fd">00351</a> <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> <a class="code" href="sys_8h.html#bf9681f6dcec783b38693e9d0b7af937">sys_arch_sem_wait</a>(<span class="keyword">struct</span> <a class="code" href="structsys__sem.html">sys_sem</a> *sem, <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> timeout) {
<a name="l00352"></a>00352   <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> time = 1;
<a name="l00353"></a>00353   <a class="code" href="ubthread_8h.html#a13bf141cd3e9bf0921fbf61ffc637d8">ubthread_mutex_lock</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>));
<a name="l00354"></a>00354   <span class="keywordflow">while</span>(sem-&gt;<a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">c</a> &lt;= 0) {
<a name="l00355"></a>00355     <span class="keywordflow">if</span>(timeout &gt; 0) {
<a name="l00356"></a>00356       time = <a class="code" href="sys__arch_8c.html#acaa002113dc0d59d767efbb1382e1ca">cond_wait</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>), &amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>), timeout);
<a name="l00357"></a>00357       <span class="keywordflow">if</span>(time == 0) {
<a name="l00358"></a>00358         <a class="code" href="ubthread_8h.html#fea3530bab360f59c09a49f490d079dd">ubthread_mutex_unlock</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>));
<a name="l00359"></a>00359         <span class="keywordflow">return</span> 0;
<a name="l00360"></a>00360       }
<a name="l00361"></a>00361     } <span class="keywordflow">else</span> {
<a name="l00362"></a>00362       <a class="code" href="sys__arch_8c.html#acaa002113dc0d59d767efbb1382e1ca">cond_wait</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>), &amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>), 0);
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364   }
<a name="l00365"></a>00365   sem-&gt;<a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">c</a>--;
<a name="l00366"></a>00366   <a class="code" href="ubthread_8h.html#fea3530bab360f59c09a49f490d079dd">ubthread_mutex_unlock</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>));
<a name="l00367"></a>00367   <span class="keywordflow">return</span>(time);
<a name="l00368"></a>00368   }
<a name="l00369"></a>00369 
<a name="l00370"></a><a class="code" href="sys__arch_8c.html#5dba9c7e95633e472717c75a21d96283">00370</a> <span class="keywordtype">void</span> <a class="code" href="sys_8h.html#dcdd78b22487e983e7636c636292fbfa">sys_sem_signal</a>(<span class="keyword">struct</span> <a class="code" href="structsys__sem.html">sys_sem</a> *sem) {
<a name="l00371"></a>00371   <a class="code" href="ubthread_8h.html#a13bf141cd3e9bf0921fbf61ffc637d8">ubthread_mutex_lock</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>));
<a name="l00372"></a>00372   sem-&gt;<a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">c</a>++;
<a name="l00373"></a>00373   <span class="keywordflow">if</span>(sem-&gt;<a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">c</a> &gt; 1)
<a name="l00374"></a>00374     sem-&gt;<a class="code" href="structsys__sem.html#7b9a8512154232d0c7cd8b007ccabca0">c</a> = 1;
<a name="l00375"></a>00375   <a class="code" href="ubthread_8h.html#64fb8f5f2da2564a6cae8c9f2c3bde10">ubthread_cond_signal</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>));
<a name="l00376"></a>00376   <a class="code" href="ubthread_8h.html#fea3530bab360f59c09a49f490d079dd">ubthread_mutex_unlock</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>));
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378 
<a name="l00379"></a><a class="code" href="sys__arch_8c.html#99ef8b5ed640213c1d06d2622889131a">00379</a> <span class="keywordtype">void</span> <a class="code" href="sys_8h.html#f36773453b6a4db5ae71afef8bb77184">sys_sem_free</a>(<span class="keyword">struct</span> <a class="code" href="structsys__sem.html">sys_sem</a> *sem) {
<a name="l00380"></a>00380   <span class="keywordflow">if</span>(sem != <a class="code" href="sys__arch_8h.html#c66fcad3bfe79589054eb31765031544">SYS_SEM_NULL</a>) {
<a name="l00381"></a>00381     <a class="code" href="sys__arch_8c.html#2c773782116a4e712bd8d4c591ab50d4">sys_sem_free_</a>(sem);
<a name="l00382"></a>00382     } 
<a name="l00383"></a>00383   }
<a name="l00384"></a>00384 
<a name="l00385"></a><a class="code" href="sys__arch_8c.html#2c773782116a4e712bd8d4c591ab50d4">00385</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="sys__arch_8c.html#2c773782116a4e712bd8d4c591ab50d4">sys_sem_free_</a>(<span class="keyword">struct</span> <a class="code" href="structsys__sem.html">sys_sem</a> *sem) {
<a name="l00386"></a>00386   <a class="code" href="ubthread_8h.html#e914fae69538736dc5e494c15ce93a17">ubthread_cond_destroy</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#a758e52262d23c22a40204e410b5f8c4">cond</a>));
<a name="l00387"></a>00387   <a class="code" href="ubthread_8h.html#278f5d5b1e11b6668b75da6a285442e4">ubthread_mutex_destroy</a>(&amp;(sem-&gt;<a class="code" href="structsys__sem.html#52b664ee7d03d9bc83f26009a5fd27f1">mutex</a>));
<a name="l00388"></a>00388   <a class="code" href="kmalloc_8h.html#aa9ed6886459604cf73ccdbf6410e487">kfree</a>(sem);
<a name="l00389"></a>00389   }
<a name="l00390"></a>00390 
<a name="l00391"></a><a class="code" href="sys__arch_8c.html#a40706a5e306545035127c0cf198cf49">00391</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="sys__arch_8c.html#a40706a5e306545035127c0cf198cf49">sys_unix_now</a>() {
<a name="l00392"></a>00392   <span class="keyword">struct </span><a class="code" href="structtimeval.html">timeval</a> tv;
<a name="l00393"></a>00393   <span class="keyword">struct </span><a class="code" href="structtimezone.html">timezone</a> tz;
<a name="l00394"></a>00394   <span class="keywordtype">long</span> sec, usec;
<a name="l00395"></a>00395   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> msec;
<a name="l00396"></a>00396   <a class="code" href="time_8h.html#df30830f5265e55035171c301eb9c3fb">gettimeofday</a>(&amp;tv, &amp;tz);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   sec = tv.<a class="code" href="structtimeval.html#3599199839a89e99a2ce29d45312b5cf">tv_sec</a> - <a class="code" href="sys__arch_8c.html#726d4f4e11d7b38233574938939e0db9">starttime</a>.<a class="code" href="structtimeval.html#3599199839a89e99a2ce29d45312b5cf">tv_sec</a>;
<a name="l00399"></a>00399   usec = tv.<a class="code" href="structtimeval.html#810bf8fcd58e255a5c1896d19538b86a">tv_usec</a> - <a class="code" href="sys__arch_8c.html#726d4f4e11d7b38233574938939e0db9">starttime</a>.<a class="code" href="structtimeval.html#810bf8fcd58e255a5c1896d19538b86a">tv_usec</a>;
<a name="l00400"></a>00400   msec = sec * 1000 + usec / 1000;
<a name="l00401"></a>00401   <span class="keywordflow">return</span> msec;
<a name="l00402"></a>00402   }
<a name="l00403"></a>00403 
<a name="l00404"></a><a class="code" href="sys__arch_8c.html#29a81985c051357162ad079023a076cd">00404</a> <span class="keywordtype">void</span> <a class="code" href="sys_8h.html#f411a8bc6b7ed4b0af9114e10c959448">sys_init</a>() {
<a name="l00405"></a>00405   <span class="keyword">struct </span><a class="code" href="structtimezone.html">timezone</a> tz;
<a name="l00406"></a>00406   <a class="code" href="time_8h.html#df30830f5265e55035171c301eb9c3fb">gettimeofday</a>(&amp;<a class="code" href="sys__arch_8c.html#726d4f4e11d7b38233574938939e0db9">starttime</a>, &amp;tz);
<a name="l00407"></a>00407   }
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="sys__arch_8c.html#2ffdebd63f7a80c0233aa7460a816dff">00409</a> <span class="keyword">struct </span><a class="code" href="structsys__timeouts.html">sys_timeouts</a> *<a class="code" href="sys_8h.html#2ffdebd63f7a80c0233aa7460a816dff">sys_arch_timeouts</a>(<span class="keywordtype">void</span>) {
<a name="l00410"></a>00410   <span class="keyword">struct </span><a class="code" href="structsys__thread.html">sys_thread</a> *<a class="code" href="structthread.html">thread</a>;
<a name="l00411"></a>00411   thread = <a class="code" href="sys__arch_8c.html#c216bafdd6453f68ef27dc764b134e94">current_thread</a>();
<a name="l00412"></a>00412   <span class="keywordflow">return</span>(&amp;thread-&gt;<a class="code" href="structsys__thread.html#bf0a0f75b1958421416c879d8011413b">timeouts</a>);
<a name="l00413"></a>00413   }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 <span class="comment">/***</span>
<a name="l00416"></a>00416 <span class="comment"> END</span>
<a name="l00417"></a>00417 <span class="comment"> ***/</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Dec 12 08:52:07 2006 for UbixOS V2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
