<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>UbixOS V2: src/sys/vmm/paging.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_897b6a2d7bab147dd1db58381aad3984.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_832905b1f7f5feaf61a306b40c0ac817.html">sys</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_b87deefade4e886319aa926bd3ba1491.html">vmm</a></div>
<h1>paging.c</h1><a href="paging_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001  <span class="comment">/*****************************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> Copyright (c) 2002-2004 The UbixOS Project</span>
<a name="l00003"></a>00003 <span class="comment"> All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment"> Redistribution and use in source and binary forms, with or without modification, are</span>
<a name="l00006"></a>00006 <span class="comment"> permitted provided that the following conditions are met:</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment"> Redistributions of source code must retain the above copyright notice, this list of</span>
<a name="l00009"></a>00009 <span class="comment"> conditions, the following disclaimer and the list of authors.  Redistributions in binary</span>
<a name="l00010"></a>00010 <span class="comment"> form must reproduce the above copyright notice, this list of conditions, the following</span>
<a name="l00011"></a>00011 <span class="comment"> disclaimer and the list of authors in the documentation and/or other materials provided</span>
<a name="l00012"></a>00012 <span class="comment"> with the distribution. Neither the name of the UbixOS Project nor the names of its</span>
<a name="l00013"></a>00013 <span class="comment"> contributors may be used to endorse or promote products derived from this software</span>
<a name="l00014"></a>00014 <span class="comment"> without specific prior written permission.</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment"> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY</span>
<a name="l00017"></a>00017 <span class="comment"> EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00018"></a>00018 <span class="comment"> MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL</span>
<a name="l00019"></a>00019 <span class="comment"> THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00020"></a>00020 <span class="comment"> SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</span>
<a name="l00021"></a>00021 <span class="comment"> OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<a name="l00022"></a>00022 <span class="comment"> HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<a name="l00023"></a>00023 <span class="comment"> TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<a name="l00024"></a>00024 <span class="comment"> SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00025"></a>00025 <span class="comment"></span>
<a name="l00026"></a>00026 <span class="comment"> $Id: paging_8c-source.html 88 2016-01-12 00:11:29Z reddawg $</span>
<a name="l00027"></a>00027 <span class="comment"></span>
<a name="l00028"></a>00028 <span class="comment">*****************************************************************************************/</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="vmm_8h.html">vmm/vmm.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="kprintf_8h.html">lib/kprintf.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="kmalloc_8h.html">lib/kmalloc.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html">ubixos/types.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="kpanic_8h.html">ubixos/kpanic.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="sched_8h.html">ubixos/sched.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="spinlock_8h.html">ubixos/spinlock.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="string_8h.html">string.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="assert_8h.html">assert.h</a>&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="paging_8c.html#4e81de2626825c90dc6bb3cd7c8b344c">00040</a> <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>         *<a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a> = 0x0;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">00043</a> <span class="keyword">static</span> <a class="code" href="spinlock_8h.html#a240e9404b4ede1e0d714610080d1176">spinLock_t</a> <a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a> = <a class="code" href="spinlock_8h.html#0fe85a4f3642683148b25916d6c5eafd">SPIN_LOCK_INITIALIZER</a>;
<a name="l00044"></a><a class="code" href="paging_8c.html#79ee934bb85cf9e184c2ad54b707f9db">00044</a> <span class="keyword">static</span> <a class="code" href="spinlock_8h.html#a240e9404b4ede1e0d714610080d1176">spinLock_t</a> <a class="code" href="paging_8c.html#79ee934bb85cf9e184c2ad54b707f9db">rmpSpinLock</a> = <a class="code" href="spinlock_8h.html#0fe85a4f3642683148b25916d6c5eafd">SPIN_LOCK_INITIALIZER</a>;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">/*****************************************************************************************</span>
<a name="l00048"></a>00048 <span class="comment"> Function: int vmm_pagingInit();</span>
<a name="l00049"></a>00049 <span class="comment"></span>
<a name="l00050"></a>00050 <span class="comment"> Description: This Function Will Initialize The Operating Systems Paging</span>
<a name="l00051"></a>00051 <span class="comment">             Abilities.</span>
<a name="l00052"></a>00052 <span class="comment"></span>
<a name="l00053"></a>00053 <span class="comment"> Notes:</span>
<a name="l00054"></a>00054 <span class="comment">  02/20/2004 - Looked Over Code And Have Approved Its Quality</span>
<a name="l00055"></a>00055 <span class="comment">  07/28/3004 - All pages are set for ring-0 only no more user accessable</span>
<a name="l00056"></a>00056 <span class="comment"></span>
<a name="l00057"></a>00057 <span class="comment">*****************************************************************************************/</span>
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="paging_8c.html#f47a45e3f0802f5aac053808127aaaf1">00059</a> <span class="keywordtype">int</span> <a class="code" href="paging_8h.html#f47a45e3f0802f5aac053808127aaaf1">vmm_pagingInit</a>(){
<a name="l00060"></a>00060   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>          i = 0x0;
<a name="l00061"></a>00061   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>         *pageTable = 0x0;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063   <span class="comment">/* Allocate A Page Of Memory For Kernels Page Directory */</span>
<a name="l00064"></a>00064   <a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a> = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(<a class="code" href="kmalloc_8h.html#81d09bc848b49133401b3efeeb65f1af">sysID</a>);
<a name="l00065"></a>00065   <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a> == 0x0) {
<a name="l00066"></a>00066     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"Error: vmmFindFreePage Failed"</span>);
<a name="l00067"></a>00067     <span class="keywordflow">return</span> (0<a class="code" href="ap-boot_8S.html#1a3ac2137e21f6f0d400f1996914dd19">x1</a>);
<a name="l00068"></a>00068     } <span class="comment">/* end if */</span>
<a name="l00069"></a>00069     
<a name="l00070"></a>00070   <span class="comment">/* Clear The Memory To Ensure There Is No Garbage */</span>
<a name="l00071"></a>00071   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="paging_8h.html#b80d68a13753e40b0df8e0dc0c4af870">pageEntries</a>; i++) {
<a name="l00072"></a>00072     (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) <a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a>[i] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) 0x0;
<a name="l00073"></a>00073   } <span class="comment">/* end for */</span>
<a name="l00074"></a>00074   
<a name="l00075"></a>00075   <span class="comment">/* Allocate a page for the first 4MB of memory */</span>
<a name="l00076"></a>00076   <span class="keywordflow">if</span> ((pageTable = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(<a class="code" href="kmalloc_8h.html#81d09bc848b49133401b3efeeb65f1af">sysID</a>)) == 0x0)
<a name="l00077"></a>00077     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"Error: vmmFindFreePage Failed"</span>);
<a name="l00078"></a>00078   <a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a>[0] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) ((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) (pageTable) | <a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>);    
<a name="l00079"></a>00079     
<a name="l00080"></a>00080   <span class="comment">/* Make Sure The Page Table Is Clean */</span>
<a name="l00081"></a>00081   <a class="code" href="lib_2string_8h.html#ce4b911463887af5e748326323e99a23">memset</a>(pageTable,0x0,0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>);
<a name="l00082"></a>00082     
<a name="l00083"></a>00083   <span class="comment">/*</span>
<a name="l00084"></a>00084 <span class="comment">   * Map the first 1MB of Memory to the kernel MM space because our kernel starts</span>
<a name="l00085"></a>00085 <span class="comment">   * at 0x30000</span>
<a name="l00086"></a>00086 <span class="comment">   * Do not map page at address 0x0 this is reserved for null...</span>
<a name="l00087"></a>00087 <span class="comment">   */</span>
<a name="l00088"></a>00088   <span class="keywordflow">for</span> (i = 0<a class="code" href="ap-boot_8S.html#1a3ac2137e21f6f0d400f1996914dd19">x1</a>; i &lt; (pageEntries / 0x4); i++) {
<a name="l00089"></a>00089     pageTable[i] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) ((i * 0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>) | <a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>);
<a name="l00090"></a>00090     } <span class="comment">/* end for */</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   <span class="comment">/*</span>
<a name="l00093"></a>00093 <span class="comment">   * Create page tables for the top 1GB of VM space. This space is set aside</span>
<a name="l00094"></a>00094 <span class="comment">   * for kernel space and will be shared with each process</span>
<a name="l00095"></a>00095 <span class="comment">   */</span>
<a name="l00096"></a>00096   <span class="keywordflow">for</span> (i = 768; i &lt; pageEntries; i++) {
<a name="l00097"></a>00097     <span class="keywordflow">if</span> ((pageTable = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(sysID)) == 0x0)
<a name="l00098"></a>00098       <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"Error: vmmFindFreePage Failed"</span>);
<a name="l00099"></a>00099       
<a name="l00100"></a>00100     <span class="comment">/* Make Sure The Page Table Is Clean */</span>
<a name="l00101"></a>00101     <a class="code" href="lib_2string_8h.html#ce4b911463887af5e748326323e99a23">memset</a>(pageTable,0x0,0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <span class="comment">/* Map In The Page Directory */</span>
<a name="l00104"></a>00104     <a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a>[i] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) ((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) (pageTable) | <a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>);
<a name="l00105"></a>00105     } <span class="comment">/* end for */</span>
<a name="l00106"></a>00106     
<a name="l00107"></a>00107   <span class="comment">/* Set Up Memory To Be All The Allocated Page Directories */</span>
<a name="l00108"></a>00108   <span class="keywordflow">if</span> ((pageTable = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(sysID)) == 0x0)
<a name="l00109"></a>00109     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"Error: vmmFindFreePage Failed"</span>);
<a name="l00110"></a>00110   
<a name="l00111"></a>00111   <span class="comment">/* Clean Page Table */</span>
<a name="l00112"></a>00112   <a class="code" href="lib_2string_8h.html#ce4b911463887af5e748326323e99a23">memset</a>(pageTable,0x0,0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>);
<a name="l00113"></a>00113   
<a name="l00114"></a>00114   <a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a>[767] = ((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) pageTable | <a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>);
<a name="l00115"></a>00115   <span class="keywordflow">for</span> (i = 0; i &lt; pageEntries; i++) {
<a name="l00116"></a>00116     pageTable[i] = <a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a>[i];
<a name="l00117"></a>00117     } <span class="comment">/* end for */</span>
<a name="l00118"></a>00118   
<a name="l00119"></a>00119   <span class="comment">/* Also Set Up Page Directory To Be The The First Page In 0xE0400000 */</span>
<a name="l00120"></a>00120   pageTable = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (<a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a>[0] &amp; 0xFFFFF000);
<a name="l00121"></a>00121   pageTable[256] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) ((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) (<a class="code" href="paging_8h.html#4e81de2626825c90dc6bb3cd7c8b344c">kernelPageDirectory</a>) | <a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123   <span class="comment">/* Now Lets Turn On Paging With This Initial Page Table */</span>
<a name="l00124"></a>00124   <span class="keyword">asm</span> <span class="keyword">volatile</span>(
<a name="l00125"></a>00125     <span class="stringliteral">"movl %0,%%eax          \n"</span>
<a name="l00126"></a>00126     <span class="stringliteral">"movl %%eax,%%cr3       \n"</span>
<a name="l00127"></a>00127     <span class="stringliteral">"movl %%cr0,%%eax       \n"</span>
<a name="l00128"></a>00128     <span class="stringliteral">"orl  $0x80010000,%%eax \n"</span> <span class="comment">/* Turn on memory protection */</span>
<a name="l00129"></a>00129     <span class="stringliteral">"movl %%eax,%%cr0       \n"</span>
<a name="l00130"></a>00130     :
<a name="l00131"></a>00131     :  <span class="stringliteral">"d"</span>((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (kernelPageDirectory))
<a name="l00132"></a>00132     );
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="comment">/* Remap The Memory List */</span>
<a name="l00135"></a>00135   <span class="keywordflow">for</span> (i = 0x101000; i &lt;= (0x101000 + (<a class="code" href="vmm_8h.html#2b0091bdc36e32af3daf9cfcaa7c04e1">numPages</a> * <span class="keyword">sizeof</span>(<a class="code" href="structmMap.html">mMap</a>))); i += 0x1000) {
<a name="l00136"></a>00136     <span class="keywordflow">if</span> ((<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>(i, (<a class="code" href="vmm_8h.html#e6d4c286bb58576d1802a2c7d92e698e">vmmMemoryMapAddr</a> + (i - 0x101000)),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>)) == 0x0)
<a name="l00137"></a>00137       <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"vmmRemapPage failed\n"</span>);
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139   <span class="comment">/* Set New Address For Memory Map Since Its Relocation */</span>
<a name="l00140"></a>00140   <a class="code" href="vmm_8h.html#89e87741958ee81f1811075b25af058a">vmmMemoryMap</a> = (<a class="code" href="structmMap.html">mMap</a> *) <a class="code" href="vmm_8h.html#e6d4c286bb58576d1802a2c7d92e698e">vmmMemoryMapAddr</a>;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="comment">/* Print information on paging */</span>
<a name="l00143"></a>00143   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"paging0 - Address: [0x%X], PagingISR Address: [0x%X]\n"</span>, kernelPageDirectory, &amp;<a class="code" href="page__fault_8S.html#6091cb277c1dd3e3e4d1d4699f3b06e5">_vmm_pageFault</a>);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145   <span class="comment">/* Return so we know everything went well */</span>
<a name="l00146"></a>00146   <span class="keywordflow">return</span> (0x0);
<a name="l00147"></a>00147   } <span class="comment">/* END */</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment">/*****************************************************************************************</span>
<a name="l00150"></a>00150 <span class="comment"> Function: int vmmRemapPage(Physical Source,Virtual Destination)</span>
<a name="l00151"></a>00151 <span class="comment"> </span>
<a name="l00152"></a>00152 <span class="comment"> Description: This Function Will Remap A Physical Page Into Virtual Space</span>
<a name="l00153"></a>00153 <span class="comment"> </span>
<a name="l00154"></a>00154 <span class="comment"> Notes:</span>
<a name="l00155"></a>00155 <span class="comment">  07/29/02 - Rewrote This To Work With Our New Paging System</span>
<a name="l00156"></a>00156 <span class="comment">  07/30/02 - Changed Address Of Page Tables And Page Directory</span>
<a name="l00157"></a>00157 <span class="comment">  07/28/04 - If perms == 0x0 set to PAGE_DEFAULT</span>
<a name="l00158"></a>00158 <span class="comment"></span>
<a name="l00159"></a>00159 <span class="comment">*****************************************************************************************/</span>
<a name="l00160"></a><a class="code" href="paging_8c.html#f055cfbfef9c5d8dd82aa83829a06117">00160</a> <span class="keywordtype">int</span> <a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>(<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> source,<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> dest,<a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> perms)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162   <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a>  destPageDirectoryIndex = 0x0, destPageTableIndex = 0x0;
<a name="l00163"></a>00163   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *pageDir = 0x0, *pageTable = 0x0;
<a name="l00164"></a>00164   <span class="keywordtype">short</span>   i = 0x0;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <span class="keywordflow">if</span> (source == 0x0)
<a name="l00167"></a>00167     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"source == 0x0"</span>);
<a name="l00168"></a>00168   <span class="keywordflow">if</span> (dest == 0x0)
<a name="l00169"></a>00169     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"dest == 0x0"</span>);
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   <a class="code" href="spinlock_8h.html#2cd9a4502680fb8e7f0fe6b029e558b1">spinLock</a>(&amp;<a class="code" href="paging_8c.html#79ee934bb85cf9e184c2ad54b707f9db">rmpSpinLock</a>);
<a name="l00172"></a>00172   <span class="keywordflow">if</span> (perms == 0x0)
<a name="l00173"></a>00173     perms = <a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   <span class="comment">/*</span>
<a name="l00176"></a>00176 <span class="comment">   * Set Pointer pageDirectory To Point To The Virtual Mapping Of The Page</span>
<a name="l00177"></a>00177 <span class="comment">   * Directory</span>
<a name="l00178"></a>00178 <span class="comment">   */</span>
<a name="l00179"></a>00179   pageDir = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) <a class="code" href="paging_8h.html#aab3609eb02bd28ded8d1ea0512da979">parentPageDirAddr</a>;
<a name="l00180"></a>00180   <span class="comment">/* Check To See If Page Table Exists */</span>
<a name="l00181"></a>00181   <span class="keywordflow">if</span> (dest == 0x0)
<a name="l00182"></a>00182     <span class="keywordflow">return</span>(0x0);
<a name="l00183"></a>00183   
<a name="l00184"></a>00184   <span class="comment">/* Get Index Into The Page Directory */</span>
<a name="l00185"></a>00185   destPageDirectoryIndex = (dest / 0x400000);
<a name="l00186"></a>00186   
<a name="l00187"></a>00187   <span class="keywordflow">if</span> ((pageDir[destPageDirectoryIndex] &amp; <a class="code" href="paging_8h.html#122dfc414a40e260fd35dbe9743db26f">PAGE_PRESENT</a>) != PAGE_PRESENT) {
<a name="l00188"></a>00188     <span class="comment">/* If Page Table Is Non Existant Then Set It Up */</span>
<a name="l00189"></a>00189     <span class="comment">/* UBU Why does the page table need to be user writable? */</span>
<a name="l00190"></a>00190     pageDir[destPageDirectoryIndex] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(<a class="code" href="sched_8h.html#54397bfe18d5da4d50ff03b15f540858">_current</a>-&gt;<a class="code" href="structtaskStruct.html#30966587a60db6b40c8be6c387e11d81">id</a>) | <a class="code" href="paging_8h.html#f0fff7a38cd2c7a32d580787423b94ea">PAGE_DEFAULT</a>;
<a name="l00191"></a>00191     
<a name="l00192"></a>00192     <span class="comment">/* Also Add It To Virtual Space So We Can Make Changes Later */</span>
<a name="l00193"></a>00193     pageTable = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (<a class="code" href="paging_8h.html#a432d41840ad8a583a7e6af86feece4f">tablesBaseAddress</a> + 0x2FF000);
<a name="l00194"></a>00194     pageTable[destPageDirectoryIndex] = pageDir[destPageDirectoryIndex];
<a name="l00195"></a>00195     <span class="comment">/* Reload Page Directory */</span>
<a name="l00196"></a>00196     <span class="keyword">asm</span> <span class="keyword">volatile</span>(
<a name="l00197"></a>00197       <span class="stringliteral">"push %eax       \n"</span>
<a name="l00198"></a>00198       <span class="stringliteral">"mov  %cr3,%eax  \n"</span>
<a name="l00199"></a>00199       <span class="stringliteral">"mov  %eax,%cr3  \n"</span>
<a name="l00200"></a>00200       <span class="stringliteral">"pop  %eax       \n"</span>
<a name="l00201"></a>00201       );
<a name="l00202"></a>00202     pageTable = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (<a class="code" href="paging_8h.html#a432d41840ad8a583a7e6af86feece4f">tablesBaseAddress</a> + (0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a> * destPageDirectoryIndex));
<a name="l00203"></a>00203     <span class="keywordflow">for</span> (i = 0x0;i &lt; <a class="code" href="paging_8h.html#b80d68a13753e40b0df8e0dc0c4af870">pageEntries</a>;i++)
<a name="l00204"></a>00204       pageTable[i] = 0x0;
<a name="l00205"></a>00205   }
<a name="l00206"></a>00206   <span class="comment">/* Set Address To Page Table */</span>
<a name="l00207"></a>00207   pageTable = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (<a class="code" href="paging_8h.html#a432d41840ad8a583a7e6af86feece4f">tablesBaseAddress</a> + (0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a> * destPageDirectoryIndex));
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="comment">/* Get The Index To The Page Table */</span>
<a name="l00210"></a>00210   destPageTableIndex = ((dest - (destPageDirectoryIndex * 0x400000)) / 0x1000);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 
<a name="l00213"></a>00213   <span class="comment">/* If The Page Is Mapped In Free It Before We Remap */</span>
<a name="l00214"></a>00214   <span class="keywordflow">if</span> ((pageTable[destPageTableIndex] &amp; PAGE_PRESENT) == PAGE_PRESENT) {
<a name="l00215"></a>00215     <span class="keywordflow">if</span> ((pageTable[destPageTableIndex] &amp; <a class="code" href="paging_8h.html#1532db17068ba8d409b8ffe066414af2">PAGE_STACK</a>) == PAGE_STACK)
<a name="l00216"></a>00216       <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"Stack Page: [0x%X]\n"</span>,dest);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keywordflow">if</span> ((pageTable[destPageTableIndex] &amp; <a class="code" href="paging_8h.html#57d743cb60fe478f6720c42315e7e813">PAGE_COW</a>) != PAGE_COW) {
<a name="l00219"></a>00219       <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"Page NOT COW\n"</span>);
<a name="l00220"></a>00220       <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"Page Present: [0x%X][0x%X]"</span>,dest,pageTable[destPageTableIndex]);
<a name="l00221"></a>00221       source = 0x0;
<a name="l00222"></a>00222       <span class="keywordflow">goto</span> rmDone;
<a name="l00223"></a>00223       }
<a name="l00224"></a>00224     <span class="comment">/* Clear The Page First For Security Reasons */</span>
<a name="l00225"></a>00225     <a class="code" href="vmm_8h.html#e90be267d851fed04d4d9b1c6c10454a">freePage</a>(((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) pageTable[destPageTableIndex] &amp; 0xFFFFF000));
<a name="l00226"></a>00226   }
<a name="l00227"></a>00227   <span class="comment">/* Set The Source Address In The Destination */</span>
<a name="l00228"></a>00228   pageTable[destPageTableIndex] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) (source | perms);
<a name="l00229"></a>00229   <span class="comment">/* Reload The Page Table; */</span>
<a name="l00230"></a>00230   <span class="keyword">asm</span> <span class="keyword">volatile</span>(
<a name="l00231"></a>00231       <span class="stringliteral">"push %eax     \n"</span>
<a name="l00232"></a>00232       <span class="stringliteral">"movl %cr3,%eax\n"</span>
<a name="l00233"></a>00233       <span class="stringliteral">"movl %eax,%cr3\n"</span>
<a name="l00234"></a>00234       <span class="stringliteral">"pop  %eax     \n"</span>
<a name="l00235"></a>00235     );
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   rmDone:
<a name="l00238"></a>00238   <span class="comment">/* Return */</span>
<a name="l00239"></a>00239   <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="paging_8c.html#79ee934bb85cf9e184c2ad54b707f9db">rmpSpinLock</a>);
<a name="l00240"></a>00240   <span class="keywordflow">return</span> (source);
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/************************************************************************</span>
<a name="l00244"></a>00244 <span class="comment"></span>
<a name="l00245"></a>00245 <span class="comment">Function: void *vmmGetFreeKernelPage(pidType pid);</span>
<a name="l00246"></a>00246 <span class="comment">Description: Returns A Free Page Mapped To The VM Space</span>
<a name="l00247"></a>00247 <span class="comment">Notes:</span>
<a name="l00248"></a>00248 <span class="comment"></span>
<a name="l00249"></a>00249 <span class="comment">07/30/02 - This Returns A Free Page In The Top 1GB For The Kernel</span>
<a name="l00250"></a>00250 <span class="comment"></span>
<a name="l00251"></a>00251 <span class="comment">************************************************************************/</span>
<a name="l00252"></a>00252 <span class="keywordtype">void</span>           *
<a name="l00253"></a><a class="code" href="paging_8c.html#30a38035243b9dfb285b3793788126be">00253</a> <a class="code" href="paging_8h.html#30a38035243b9dfb285b3793788126be">vmmGetFreeKernelPage</a>(<a class="code" href="types_8h.html#e438ba74394b14d7b24b6df3b3b8c252">pidType</a> pid, <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> count)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255   <span class="keywordtype">int</span>             x = 0, y = 0, c = 0;
<a name="l00256"></a>00256   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>         *pageTableSrc = 0x0;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258   <a class="code" href="spinlock_8h.html#2cd9a4502680fb8e7f0fe6b029e558b1">spinLock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00259"></a>00259   <span class="comment">/* Lets Search For A Free Page */</span>
<a name="l00260"></a>00260   <span class="keywordflow">for</span> (x = 768; x &lt; 1024; x++) {
<a name="l00261"></a>00261     <span class="comment">/* Set Page Table Address */</span>
<a name="l00262"></a>00262     pageTableSrc = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (<a class="code" href="paging_8h.html#a432d41840ad8a583a7e6af86feece4f">tablesBaseAddress</a> + (4096 * x));
<a name="l00263"></a>00263     <span class="keywordflow">for</span> (y = 0; y &lt; 1024; y++) {
<a name="l00264"></a>00264       <span class="comment">/* Loop Through The Page Table Find An UnAllocated Page */</span>
<a name="l00265"></a>00265       <span class="keywordflow">if</span> ((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) pageTableSrc[y] == (uInt32) 0x0) {
<a name="l00266"></a>00266         <span class="keywordflow">if</span> (count &gt; 1) {
<a name="l00267"></a>00267           <span class="keywordflow">for</span> (c = 0; c &lt; count; c++) {
<a name="l00268"></a>00268             <span class="keywordflow">if</span> (y + c &lt; 1024) {
<a name="l00269"></a>00269               <span class="keywordflow">if</span> ((uInt32) pageTableSrc[y + c] != (uInt32) 0x0) {
<a name="l00270"></a>00270                 c = -1;
<a name="l00271"></a>00271                 <span class="keywordflow">break</span>;
<a name="l00272"></a>00272                 }
<a name="l00273"></a>00273               }
<a name="l00274"></a>00274             }
<a name="l00275"></a>00275           <span class="keywordflow">if</span> (c != -1) {
<a name="l00276"></a>00276             <span class="keywordflow">for</span> (c = 0; c &lt; count; c++) {
<a name="l00277"></a>00277               <span class="keywordflow">if</span> ((<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>((uInt32) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(pid), ((x * (1024 * 4096)) + ((y + c) * 4096)),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>)) == 0x0)
<a name="l00278"></a>00278                 <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"vmmRemapPage failed: gfkp-1\n"</span>);
<a name="l00279"></a>00279               <a class="code" href="paging_8h.html#230a160ddb717c5a133e55aa42e9d324">vmmClearVirtualPage</a>((uInt32) ((x * (1024 * 4096)) + ((y + c) * 4096)));
<a name="l00280"></a>00280             }
<a name="l00281"></a>00281             <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00282"></a>00282             <span class="keywordflow">return</span> ((<span class="keywordtype">void</span> *)((x * (1024 * 4096)) + (y * 4096)));
<a name="l00283"></a>00283           }
<a name="l00284"></a>00284         } <span class="keywordflow">else</span> {
<a name="l00285"></a>00285           <span class="comment">/* Map A Physical Page To The Virtual Page */</span>
<a name="l00286"></a>00286 
<a name="l00287"></a>00287           <span class="keywordflow">if</span> ((<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>((uInt32) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(pid), ((x * (1024 * 4096)) + (y * 4096)),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>)) == 0x0)
<a name="l00288"></a>00288             <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"vmmRemapPage failed: gfkp-2\n"</span>);
<a name="l00289"></a>00289           <span class="comment">/* Clear This Page So No Garbage Is There */</span>
<a name="l00290"></a>00290           <a class="code" href="paging_8h.html#230a160ddb717c5a133e55aa42e9d324">vmmClearVirtualPage</a>((uInt32) ((x * (1024 * 4096)) + (y * 4096)));
<a name="l00291"></a>00291           <span class="comment">/* Return The Address Of The Newly Allocate Page */</span>
<a name="l00292"></a>00292           <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00293"></a>00293           <span class="keywordflow">return</span> ((<span class="keywordtype">void</span> *)((x * (1024 * 4096)) + (y * 4096)));
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295       }
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297   }
<a name="l00298"></a>00298   <span class="comment">/* If No Free Page Was Found Return NULL */</span>
<a name="l00299"></a>00299   <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00300"></a>00300   <span class="keywordflow">return</span> (0x0);
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="comment">/************************************************************************</span>
<a name="l00305"></a>00305 <span class="comment"></span>
<a name="l00306"></a>00306 <span class="comment">Function: void vmmClearVirtualPage(uInt32 pageAddr);</span>
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">Description: This Will Null Out A Page Of Memory</span>
<a name="l00309"></a>00309 <span class="comment"></span>
<a name="l00310"></a>00310 <span class="comment">Notes:</span>
<a name="l00311"></a>00311 <span class="comment"></span>
<a name="l00312"></a>00312 <span class="comment">************************************************************************/</span>
<a name="l00313"></a>00313 <span class="keywordtype">int</span> 
<a name="l00314"></a><a class="code" href="paging_8c.html#230a160ddb717c5a133e55aa42e9d324">00314</a> <a class="code" href="paging_8h.html#230a160ddb717c5a133e55aa42e9d324">vmmClearVirtualPage</a>(<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> pageAddr)
<a name="l00315"></a>00315 {
<a name="l00316"></a>00316   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>         *src = 0x0;
<a name="l00317"></a>00317   <span class="keywordtype">int</span>             counter = 0x0;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="comment">/* Set Source Pointer To Virtual Page Address */</span>
<a name="l00320"></a>00320   src = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) pageAddr;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <span class="comment">/* Clear Out The Page */</span>
<a name="l00323"></a>00323   <span class="keywordflow">for</span> (counter = 0x0; counter &lt; <a class="code" href="paging_8h.html#b80d68a13753e40b0df8e0dc0c4af870">pageEntries</a>; counter++) {
<a name="l00324"></a>00324     (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) src[counter] = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) 0x0;
<a name="l00325"></a>00325   }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327   <span class="comment">/* Return */</span>
<a name="l00328"></a>00328   <span class="keywordflow">return</span> (0x0);
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="paging_8c.html#5eb37b88b24489f7256232eec46de565">00332</a> <span class="keywordtype">void</span> *<a class="code" href="paging_8h.html#8f335022705939f0a6553d289b9c1e4e">vmmMapFromTask</a>(<a class="code" href="types_8h.html#e438ba74394b14d7b24b6df3b3b8c252">pidType</a> pid,<span class="keywordtype">void</span> *ptr,<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> size) {
<a name="l00333"></a>00333   <a class="code" href="structtaskStruct.html">kTask_t</a> *child = 0x0;
<a name="l00334"></a>00334   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> i = 0x0,x = 0x0,y = 0x0,count = ((size+4095)/0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>),c = 0x0;
<a name="l00335"></a>00335   <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> dI = 0x0,tI = 0x0;
<a name="l00336"></a>00336   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> baseAddr = 0x0,offset = 0x0;
<a name="l00337"></a>00337   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *childPageDir   = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *)0x5A00000;
<a name="l00338"></a>00338   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *childPageTable = 0x0;
<a name="l00339"></a>00339   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *pageTableSrc   = 0x0;
<a name="l00340"></a>00340   offset = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>)ptr &amp; 0xFFF;
<a name="l00341"></a>00341   baseAddr = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>)ptr &amp; 0xFFFFF000;
<a name="l00342"></a>00342   child = <a class="code" href="sched_8h.html#9cf37ade4c1f6184b33014ac2015e8ed">schedFindTask</a>(pid);
<a name="l00343"></a>00343   <span class="comment">//Calculate The Page Table Index And Page Directory Index</span>
<a name="l00344"></a>00344   dI = (baseAddr/(1024*4096));
<a name="l00345"></a>00345   tI = ((baseAddr-(dI*(1024*4096)))/4096);
<a name="l00346"></a>00346   <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>(child-&gt;<a class="code" href="structtaskStruct.html#4c8accd7c0d5bb5ce426dc982bfc8519">tss</a>.<a class="code" href="structtssStruct.html#8d312ed3dd0ea7a0f801c08a8cc4afd0">cr3</a>,0x5A00000,<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>) == 0x0)
<a name="l00347"></a>00347     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"vmmFailed"</span>);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349   <span class="keywordflow">for</span> (i=0;i&lt;0x1000;i++) {
<a name="l00350"></a>00350     <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>(childPageDir[i],0x5A01000 + (i * 0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>) == 0x0)
<a name="l00351"></a>00351       <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"Returned NULL"</span>);
<a name="l00352"></a>00352     }
<a name="l00353"></a>00353   <span class="keywordflow">for</span> (x=(<a class="code" href="sched_8h.html#54397bfe18d5da4d50ff03b15f540858">_current</a>-&gt;<a class="code" href="structtaskStruct.html#0933c70230d4ac8bc9953640c979f8d7">oInfo</a>.<a class="code" href="structosInfo.html#2833c1fa4a221941b5d1141dfa5beefd">vmStart</a>/(1024*4096));x&lt;1024;x++) {
<a name="l00354"></a>00354     pageTableSrc = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *)(<a class="code" href="paging_8h.html#a432d41840ad8a583a7e6af86feece4f">tablesBaseAddress</a> + (4096*x));
<a name="l00355"></a>00355     <span class="keywordflow">for</span> (y=0;y&lt;1024;y++) {
<a name="l00356"></a>00356       <span class="comment">//Loop Through The Page Table Find An UnAllocated Page</span>
<a name="l00357"></a>00357       <span class="keywordflow">if</span> ((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>)pageTableSrc[y] == (uInt32)0x0) {
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (count &gt; 1) {
<a name="l00359"></a>00359           <span class="keywordflow">for</span> (c=0;((c&lt;count) &amp;&amp; (y+c &lt; 1024));c++) {
<a name="l00360"></a>00360             <span class="keywordflow">if</span> ((uInt32)pageTableSrc[y+c] != (uInt32)0x0) {
<a name="l00361"></a>00361               c = -1;
<a name="l00362"></a>00362               <span class="keywordflow">break</span>;
<a name="l00363"></a>00363               }
<a name="l00364"></a>00364             }
<a name="l00365"></a>00365           <span class="keywordflow">if</span> (c != -1) {
<a name="l00366"></a>00366             <span class="keywordflow">for</span> (c=0;c&lt;count;c++) {
<a name="l00367"></a>00367               <span class="keywordflow">if</span> ((tI + c) &gt;= 0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>) {
<a name="l00368"></a>00368                 dI++;
<a name="l00369"></a>00369                 tI = 0-c;
<a name="l00370"></a>00370                 }
<a name="l00371"></a>00371               childPageTable = (uInt32 *)(0x5A01000 + (0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a> * dI));
<a name="l00372"></a>00372               <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>(childPageTable[tI+c],((x*(1024*4096))+((y+c)*4096)),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>) == 0x0)
<a name="l00373"></a>00373                 <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"remap == NULL"</span>);
<a name="l00374"></a>00374               }
<a name="l00375"></a>00375             <a class="code" href="paging_8h.html#fd94da50e455602f86ad7dae2fc9d1db">vmmUnmapPage</a>(0x5A00000,1);
<a name="l00376"></a>00376             <span class="keywordflow">for</span> (i=0;i&lt;0x1000;i++) {
<a name="l00377"></a>00377               <a class="code" href="paging_8h.html#fd94da50e455602f86ad7dae2fc9d1db">vmmUnmapPage</a>((0x5A01000 + (i*0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>)),1);
<a name="l00378"></a>00378               }
<a name="l00379"></a>00379             <span class="keywordflow">return</span>((<span class="keywordtype">void</span> *)((x*(1024*4096))+(y*4096)+offset));
<a name="l00380"></a>00380             }
<a name="l00381"></a>00381           }
<a name="l00382"></a>00382         <span class="keywordflow">else</span> {
<a name="l00383"></a>00383           <span class="comment">//Map A Physical Page To The Virtual Page</span>
<a name="l00384"></a>00384           childPageTable = (uInt32 *)(0x5A01000 + (0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a> * dI));
<a name="l00385"></a>00385           <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>(childPageTable[tI],((x*(1024*4096))+(y*4096)),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>) == 0x0)
<a name="l00386"></a>00386             <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"remap Failed"</span>);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388           <span class="comment">//Return The Address Of The Mapped In Memory</span>
<a name="l00389"></a>00389           <a class="code" href="paging_8h.html#fd94da50e455602f86ad7dae2fc9d1db">vmmUnmapPage</a>(0x5A00000,1);
<a name="l00390"></a>00390           <span class="keywordflow">for</span> (i=0;i&lt;0x1000;i++) {
<a name="l00391"></a>00391             <a class="code" href="paging_8h.html#fd94da50e455602f86ad7dae2fc9d1db">vmmUnmapPage</a>((0x5A01000 + (i*0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>)),1);
<a name="l00392"></a>00392             }
<a name="l00393"></a>00393           <span class="keywordflow">return</span>((<span class="keywordtype">void</span> *)((x*(1024*4096))+(y*4096)+offset));
<a name="l00394"></a>00394           }
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396       }
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398   <span class="keywordflow">return</span>(0x0);
<a name="l00399"></a>00399   }
<a name="l00400"></a>00400 
<a name="l00401"></a><a class="code" href="paging_8c.html#541f0b43826a40b9e978f5479080bb0e">00401</a> <span class="keywordtype">void</span> *<a class="code" href="paging_8h.html#541f0b43826a40b9e978f5479080bb0e">vmm_getFreeMallocPage</a>(<a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a> count) {
<a name="l00402"></a>00402   <a class="code" href="types_8h.html#3b65128d2644e9b80cec9a69bfa7e094">uInt16</a>  x = 0x0, y = 0x0;
<a name="l00403"></a>00403   <span class="keywordtype">int</span>     c = 0x0;
<a name="l00404"></a>00404   <a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *pageTableSrc = 0x0;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406   <a class="code" href="spinlock_8h.html#2cd9a4502680fb8e7f0fe6b029e558b1">spinLock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00407"></a>00407   <span class="comment">/* Lets Search For A Free Page */</span>
<a name="l00408"></a>00408   <span class="keywordflow">for</span> (x = 960; x &lt; 1024; x++) {
<a name="l00409"></a>00409     <span class="comment">/* Set Page Table Address */</span>
<a name="l00410"></a>00410     pageTableSrc = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (<a class="code" href="paging_8h.html#a432d41840ad8a583a7e6af86feece4f">tablesBaseAddress</a> + (0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a> * x));
<a name="l00411"></a>00411     <span class="keywordflow">for</span> (y = 0; y &lt; 1024; y++) {
<a name="l00412"></a>00412       <span class="comment">/* Loop Through The Page Table Find An UnAllocated Page */</span>
<a name="l00413"></a>00413       <span class="keywordflow">if</span> ((<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a>) pageTableSrc[y] == (uInt32) 0x0) {
<a name="l00414"></a>00414         <span class="keywordflow">if</span> (count &gt; 1) {
<a name="l00415"></a>00415           <span class="keywordflow">for</span> (c = 0; c &lt; count; c++) {
<a name="l00416"></a>00416             <span class="keywordflow">if</span> (y + c &lt; 1024) {
<a name="l00417"></a>00417               <span class="keywordflow">if</span> ((uInt32) pageTableSrc[y + c] != (uInt32) 0x0) {
<a name="l00418"></a>00418                 c = -1;
<a name="l00419"></a>00419                 <span class="keywordflow">break</span>;
<a name="l00420"></a>00420                 }
<a name="l00421"></a>00421               }
<a name="l00422"></a>00422             }
<a name="l00423"></a>00423           <span class="keywordflow">if</span> (c != -1) {
<a name="l00424"></a>00424             <span class="keywordflow">for</span> (c = 0; c &lt; count; c++) {
<a name="l00425"></a>00425               <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>((uInt32) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(<a class="code" href="kmalloc_8h.html#81d09bc848b49133401b3efeeb65f1af">sysID</a>), ((x * 0x400000) + ((y + c) * 0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>)),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>) == 0x0)
<a name="l00426"></a>00426                 <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"remap Failed"</span>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428               <a class="code" href="paging_8h.html#230a160ddb717c5a133e55aa42e9d324">vmmClearVirtualPage</a>((uInt32) ((x * 0x400000) + ((y + c) * 0x1000)));
<a name="l00429"></a>00429               }
<a name="l00430"></a>00430             <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00431"></a>00431             <span class="keywordflow">return</span> ((<span class="keywordtype">void</span> *)((x * 0x400000) + (y * 0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>)));
<a name="l00432"></a>00432             }
<a name="l00433"></a>00433           }
<a name="l00434"></a>00434         <span class="keywordflow">else</span> {
<a name="l00435"></a>00435           <span class="comment">/* Map A Physical Page To The Virtual Page */</span>
<a name="l00436"></a>00436           <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>((uInt32) <a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(<a class="code" href="kmalloc_8h.html#81d09bc848b49133401b3efeeb65f1af">sysID</a>), ((x * 0x400000) + (y * 0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>)),<a class="code" href="paging_8h.html#8b838cda4f0bc79ab8d07eb19dd35420">KERNEL_PAGE_DEFAULT</a>) == 0x0)
<a name="l00437"></a>00437             <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"Failed"</span>);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439           <span class="comment">/* Clear This Page So No Garbage Is There */</span>
<a name="l00440"></a>00440           <a class="code" href="paging_8h.html#230a160ddb717c5a133e55aa42e9d324">vmmClearVirtualPage</a>((uInt32) ((x * 0x400000) + (y * 0x1000)));
<a name="l00441"></a>00441           <span class="comment">/* Return The Address Of The Newly Allocate Page */</span>
<a name="l00442"></a>00442           <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00443"></a>00443           <span class="keywordflow">return</span> ((<span class="keywordtype">void</span> *)((x * 0x400000) + (y * 0x1000)));
<a name="l00444"></a>00444           }
<a name="l00445"></a>00445         }
<a name="l00446"></a>00446       }
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448   <span class="comment">/* If No Free Page Was Found Return NULL */</span>
<a name="l00449"></a>00449   <a class="code" href="spinlock_8h.html#dd996cbbb3b9826dd9c8cf02b66a4c65">spinUnlock</a>(&amp;<a class="code" href="paging_8c.html#fe74a297627a1834d20925533b77c3d8">fkpSpinLock</a>);
<a name="l00450"></a>00450   <span class="keywordflow">return</span> (0x0);
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452   
<a name="l00453"></a><a class="code" href="paging_8c.html#b3070a217a42db69cd94b6217f0b361a">00453</a> <span class="keywordtype">int</span> <a class="code" href="syscalls__new_8h.html#9721caa05ef16cbf780658769bfd537a">mmap</a>(<span class="keyword">struct</span> <a class="code" href="structthread.html">thread</a> *td,<span class="keyword">struct</span> <a class="code" href="structmmap__args.html">mmap_args</a> *uap) {
<a name="l00454"></a>00454   <a class="code" href="types_8h.html#d6f327965d9e330cd225ca2153ac0453">vm_offset_t</a> addr = 0x0;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456   addr = (<a class="code" href="types_8h.html#d6f327965d9e330cd225ca2153ac0453">vm_offset_t</a>) uap-&gt;<a class="code" href="structmmap__args.html#13ec5b173a8fe6428cf3bf0a5f2d4fc2">addr</a>;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   #ifdef DEBUG
<a name="l00459"></a>00459   if (uap-&gt;<a class="code" href="structmmap__args.html#13ec5b173a8fe6428cf3bf0a5f2d4fc2">addr</a> != 0x0) {
<a name="l00460"></a>00460     <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"Address hints are not supported yet.\n"</span>);
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"uap-&gt;flags: [0x%X]\n"</span>,uap-&gt;<a class="code" href="structmmap__args.html#04b82aa69d28fc03e57632b7d524758d">flags</a>);
<a name="l00463"></a>00463   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"uap-&gt;addr:  [0x%X]\n"</span>,uap-&gt;<a class="code" href="structmmap__args.html#13ec5b173a8fe6428cf3bf0a5f2d4fc2">addr</a>);
<a name="l00464"></a>00464   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"uap-&gt;len:   [0x%X]\n"</span>,uap-&gt;<a class="code" href="structmmap__args.html#0b1dab766559d59a733fede0d3767c14">len</a>);
<a name="l00465"></a>00465   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"uap-&gt;prot:  [0x%X]\n"</span>,uap-&gt;<a class="code" href="structmmap__args.html#d6c74b2bf9e921cb4da0cbd508b2e21d">prot</a>);
<a name="l00466"></a>00466   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"uap-&gt;fd:    [%i]\n"</span>,uap-&gt;<a class="code" href="structmmap__args.html#abfe32d5934305c27dd528bba990ae12">fd</a>);
<a name="l00467"></a>00467   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"uap-&gt;pad:   [0x%X]\n"</span>,uap-&gt;<a class="code" href="structmmap__args.html#5ad4ee0f25f92b5a4da5a86ba40ee1e2">pad</a>);
<a name="l00468"></a>00468   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"uap-&gt;pos:   [0x%X]\n"</span>,uap-&gt;<a class="code" href="structmmap__args.html#7cc0a114bae15892a406fa7196229e37">pos</a>);
<a name="l00469"></a>00469 <span class="preprocessor">  #endif</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span>
<a name="l00471"></a>00471   <span class="keywordflow">if</span> (uap-&gt;<a class="code" href="structmmap__args.html#abfe32d5934305c27dd528bba990ae12">fd</a> == -1)
<a name="l00472"></a>00472     td-&gt;<a class="code" href="structthread.html#f3ec0788a84e5cb640a1646d1347998a">td_retval</a>[0] = <a class="code" href="paging_8h.html#4b324672c4b25064eb8db1e3419337b1">vmmGetFreeVirtualPage</a>(<a class="code" href="sched_8h.html#54397bfe18d5da4d50ff03b15f540858">_current</a>-&gt;<a class="code" href="structtaskStruct.html#30966587a60db6b40c8be6c387e11d81">id</a>,uap-&gt;<a class="code" href="structmmap__args.html#0b1dab766559d59a733fede0d3767c14">len</a>/0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a>,<a class="code" href="paging_8h.html#59a518704bf2f0b56603476bcb1eebbf">VM_TASK</a>);
<a name="l00473"></a>00473   <span class="keywordflow">else</span> 
<a name="l00474"></a>00474     td-&gt;<a class="code" href="structthread.html#f3ec0788a84e5cb640a1646d1347998a">td_retval</a>[0] = 0x0;
<a name="l00475"></a>00475   <span class="keywordflow">return</span>(0x0);
<a name="l00476"></a>00476   }
<a name="l00477"></a>00477 
<a name="l00478"></a><a class="code" href="paging_8c.html#6cdf3466734f2da5e258c9844d536295">00478</a> <span class="keywordtype">int</span> <a class="code" href="syscalls__new_8h.html#7f9e3f42e3fe0ba5e2dd3a4140ef14de">obreak</a>(<span class="keyword">struct</span> <a class="code" href="structthread.html">thread</a> *td,<span class="keyword">struct</span> <a class="code" href="structobreak__args.html">obreak_args</a> *uap) {
<a name="l00479"></a>00479   <a class="code" href="types_8h.html#ba29fd78d95cce0ecb249c24b58d07da">u_int32_t</a>   i    = 0x0;
<a name="l00480"></a>00480   <a class="code" href="types_8h.html#d6f327965d9e330cd225ca2153ac0453">vm_offset_t</a> old  = 0x0;
<a name="l00481"></a>00481   <a class="code" href="types_8h.html#d6f327965d9e330cd225ca2153ac0453">vm_offset_t</a> base = 0x0;
<a name="l00482"></a>00482   <a class="code" href="types_8h.html#d6f327965d9e330cd225ca2153ac0453">vm_offset_t</a> <span class="keyword">new</span>  = 0x0;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="preprocessor">  #ifdef DEBUG</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span>  <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"vm_offset_t: [%i]\n"</span>,<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#d6f327965d9e330cd225ca2153ac0453">vm_offset_t</a>));
<a name="l00486"></a>00486   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"nsize:    [0x%X]\n"</span>,uap-&gt;<a class="code" href="structobreak__args.html#b30a3d3c9186553a40d1b6e7c5714fb4">nsize</a>);
<a name="l00487"></a>00487   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"vm_daddr: [0x%X]\n"</span>,td-&gt;<a class="code" href="structthread.html#c770300b493b2ea844e634b7c98c4f6a">vm_daddr</a>);
<a name="l00488"></a>00488   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"vm_dsize: [0x%X]\n"</span>,td-&gt;<a class="code" href="structthread.html#4ce0e0e5856efc85e111d2cb8748a0ee">vm_dsize</a>);
<a name="l00489"></a>00489   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"total:    [0x%X]\n"</span>,td-&gt;<a class="code" href="structthread.html#c770300b493b2ea844e634b7c98c4f6a">vm_daddr</a> + td-&gt;<a class="code" href="structthread.html#4ce0e0e5856efc85e111d2cb8748a0ee">vm_dsize</a>);
<a name="l00490"></a>00490 <span class="preprocessor">  #endif</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>
<a name="l00492"></a>00492   <span class="keyword">new</span>  = <a class="code" href="paging_8h.html#2702263fcf2b3b026cb26c6d895cb0ee">round_page</a>((vm_offset_t)uap-&gt;<a class="code" href="structobreak__args.html#b30a3d3c9186553a40d1b6e7c5714fb4">nsize</a>);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   base = <a class="code" href="paging_8h.html#2702263fcf2b3b026cb26c6d895cb0ee">round_page</a>((vm_offset_t)td-&gt;<a class="code" href="structthread.html#c770300b493b2ea844e634b7c98c4f6a">vm_daddr</a>);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   old = base + <a class="code" href="paging_8h.html#071caea8a82a06e754daca63317d3c07">ctob</a>(td-&gt;<a class="code" href="structthread.html#4ce0e0e5856efc85e111d2cb8748a0ee">vm_dsize</a>);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="keywordflow">if</span> (<span class="keyword">new</span> &lt; base) 
<a name="l00499"></a>00499     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"EINVAL"</span>);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   <span class="keywordflow">if</span> (<span class="keyword">new</span> &gt; old) {
<a name="l00502"></a>00502     <span class="keywordflow">for</span> (i = old;i &lt; <span class="keyword">new</span>;i+= 0x1000) {
<a name="l00503"></a>00503       <span class="keywordflow">if</span> (<a class="code" href="paging_8h.html#a05f8d8947fb5bcec87fc6661f83243e">vmm_remapPage</a>(<a class="code" href="vmm_8h.html#976cf3919bf7c77c868021ec9374593b">vmmFindFreePage</a>(<a class="code" href="sched_8h.html#54397bfe18d5da4d50ff03b15f540858">_current</a>-&gt;<a class="code" href="structtaskStruct.html#30966587a60db6b40c8be6c387e11d81">id</a>),i,<a class="code" href="paging_8h.html#f0fff7a38cd2c7a32d580787423b94ea">PAGE_DEFAULT</a>) == 0x0)
<a name="l00504"></a>00504         <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"remap Failed"</span>);
<a name="l00505"></a>00505       }
<a name="l00506"></a>00506     td-&gt;<a class="code" href="structthread.html#4ce0e0e5856efc85e111d2cb8748a0ee">vm_dsize</a> += <a class="code" href="paging_8h.html#0851ee42f36c8a00e9eafe739c8ffaaa">btoc</a>(<span class="keyword">new</span> - old);
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">new</span> &lt; old) {
<a name="l00509"></a>00509     <a class="code" href="kpanic_8h.html#a5193288597f00c4f8e3b2939aa6c0ce">K_PANIC</a>(<span class="stringliteral">"new &lt; old"</span>); 
<a name="l00510"></a>00510     td-&gt;<a class="code" href="structthread.html#4ce0e0e5856efc85e111d2cb8748a0ee">vm_dsize</a> -= <a class="code" href="paging_8h.html#0851ee42f36c8a00e9eafe739c8ffaaa">btoc</a>(old - <span class="keyword">new</span>);
<a name="l00511"></a>00511     }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   <span class="keywordflow">return</span>(0x0);
<a name="l00514"></a>00514   }
<a name="l00515"></a>00515 
<a name="l00516"></a><a class="code" href="paging_8c.html#2ef18727032511b619759847d8c21720">00516</a> <span class="keywordtype">int</span> <a class="code" href="syscalls__new_8h.html#94676b8bce29788e36abad710783e545">munmap</a>(<span class="keyword">struct</span> <a class="code" href="structthread.html">thread</a> *td,<span class="keyword">struct</span> <a class="code" href="structmunmap__args.html">munmap_args</a> *uap) {
<a name="l00517"></a>00517   <span class="comment">/* HACK */</span>
<a name="l00518"></a>00518   <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"munmap"</span>);
<a name="l00519"></a>00519   <span class="keywordflow">return</span>(0x0);
<a name="l00520"></a>00520   }
<a name="l00521"></a>00521 
<a name="l00522"></a><a class="code" href="paging_8c.html#0444c8635648fabdbd6e702137aa1723">00522</a> <span class="keywordtype">int</span> <a class="code" href="paging_8c.html#0444c8635648fabdbd6e702137aa1723">vmm_cleanVirtualSpace</a>(<a class="code" href="types_8h.html#ba29fd78d95cce0ecb249c24b58d07da">u_int32_t</a> addr) {
<a name="l00523"></a>00523   <span class="keywordtype">int</span>         x            = 0x0;
<a name="l00524"></a>00524   <span class="keywordtype">int</span>         y            = 0x0;
<a name="l00525"></a>00525   <a class="code" href="types_8h.html#ba29fd78d95cce0ecb249c24b58d07da">u_int32_t</a>  *pageTableSrc = 0x0;
<a name="l00526"></a>00526   <a class="code" href="types_8h.html#ba29fd78d95cce0ecb249c24b58d07da">u_int32_t</a>  *pageDir      = 0x0;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   pageDir = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) <a class="code" href="paging_8h.html#aab3609eb02bd28ded8d1ea0512da979">parentPageDirAddr</a>;
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 <span class="preprocessor">  #ifdef DEBUG</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span>  <a class="code" href="kprint_8h.html#b2761bdf0cca73ad0fb5880895210cd8">kprintf</a>(<span class="stringliteral">"CVS: [0x%X]\n"</span>,addr);
<a name="l00532"></a>00532 <span class="preprocessor">  #endif</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span>
<a name="l00534"></a>00534   <span class="keywordflow">for</span> (x = (addr / (1024 * 4096)); x &lt; 770; x++) {
<a name="l00535"></a>00535     <span class="keywordflow">if</span> ((pageDir[x] &amp; <a class="code" href="paging_8h.html#122dfc414a40e260fd35dbe9743db26f">PAGE_PRESENT</a>) == PAGE_PRESENT) {
<a name="l00536"></a>00536       pageTableSrc = (<a class="code" href="types_8h.html#5847ea0262a5aa61eee48cbe95544a78">uInt32</a> *) (<a class="code" href="paging_8h.html#a432d41840ad8a583a7e6af86feece4f">tablesBaseAddress</a> + (0<a class="code" href="ap-boot_8S.html#f78b91f02427adef14bb8b28aa93baa5">x1000</a> * x));
<a name="l00537"></a>00537       <span class="keywordflow">for</span> (y = 0;y &lt; 1024;y++) {
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (pageTableSrc[y] != 0x0) { 
<a name="l00539"></a>00539           <span class="keywordflow">if</span> ((pageTableSrc[y] &amp; <a class="code" href="paging_8h.html#57d743cb60fe478f6720c42315e7e813">PAGE_COW</a>) == PAGE_COW) {
<a name="l00540"></a>00540             <span class="comment">//kprintf("COWi*");</span>
<a name="l00541"></a>00541             pageTableSrc[y] = 0x0;
<a name="l00542"></a>00542             }
<a name="l00543"></a>00543           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pageTableSrc[y] &amp; <a class="code" href="paging_8h.html#1532db17068ba8d409b8ffe066414af2">PAGE_STACK</a>) == PAGE_STACK) {
<a name="l00544"></a>00544             <span class="comment">//pageTableSrc[y] = 0x0;</span>
<a name="l00545"></a>00545             <span class="comment">//kprintf("STACK: (%i:%i)",x,y);</span>
<a name="l00546"></a>00546             }
<a name="l00547"></a>00547           <span class="keywordflow">else</span> {
<a name="l00548"></a>00548             <span class="comment">//kprintf("+");</span>
<a name="l00549"></a>00549             }
<a name="l00550"></a>00550           }
<a name="l00551"></a>00551         }
<a name="l00552"></a>00552       }
<a name="l00553"></a>00553     }
<a name="l00554"></a>00554   <span class="keyword">asm</span>(
<a name="l00555"></a>00555     <span class="stringliteral">"movl %cr3,%eax\n"</span>
<a name="l00556"></a>00556     <span class="stringliteral">"movl %eax,%cr3\n"</span>
<a name="l00557"></a>00557     );
<a name="l00558"></a>00558   <span class="keywordflow">return</span>(0x0);
<a name="l00559"></a>00559   }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 <span class="comment">/***</span>
<a name="l00562"></a>00562 <span class="comment"> END</span>
<a name="l00563"></a>00563 <span class="comment"> ***/</span>
<a name="l00564"></a>00564 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Dec 15 11:18:55 2006 for UbixOS V2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
